---
phase: 20-core-gauntlet-loop-transitions
plan: 03
type: execute
wave: 2
depends_on: ["20-01", "20-02"]
files_modified:
  - src/components/gauntlet/GauntletModeScreen.tsx
  - src/components/gauntlet/index.ts
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "Player can play sequential 1v1 duels from Gauntlet mode"
    - "Player's dice count persists between duels"
    - "AI difficulty escalates as streak grows"
    - "Victory splash appears after winning, then fight card for next opponent"
    - "Game over screen appears when player loses all dice"
  artifacts:
    - path: "src/components/gauntlet/GauntletModeScreen.tsx"
      provides: "Main gauntlet container with screen flow"
      exports: ["GauntletModeScreen"]
    - path: "src/app/page.tsx"
      provides: "Gauntlet mode integration in main app"
      contains: "GauntletModeScreen"
  key_links:
    - from: "src/components/gauntlet/GauntletModeScreen.tsx"
      to: "useGauntletStore"
      via: "store subscription"
      pattern: "useGauntletStore"
    - from: "src/app/page.tsx"
      to: "GauntletModeScreen"
      via: "conditional render"
      pattern: "gameState.*Gauntlet"
---

<objective>
Wire Gauntlet mode: create GauntletModeScreen container that orchestrates the full gameplay loop.

Purpose: Integrate all gauntlet components into a working flow where player progresses through rules -> fight card -> gameplay -> victory/defeat -> repeat or game over. This is the integration plan that makes Gauntlet playable.

Output: Working Gauntlet mode accessible from main menu with complete gameplay loop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

Phase context:
@.planning/phases/20-core-gauntlet-loop-transitions/20-CONTEXT.md
@.planning/phases/20-core-gauntlet-loop-transitions/20-RESEARCH.md

Prior plan summaries (required):
@.planning/phases/20-core-gauntlet-loop-transitions/20-01-SUMMARY.md
@.planning/phases/20-core-gauntlet-loop-transitions/20-02-SUMMARY.md

Existing patterns:
@src/app/page.tsx
@src/stores/gauntletStore.ts
@src/components/gauntlet/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GauntletModeScreen container</name>
  <files>src/components/gauntlet/GauntletModeScreen.tsx, src/components/gauntlet/index.ts</files>
  <action>
Create the main GauntletModeScreen component that orchestrates the entire gauntlet flow.

Props interface:
- `playerColor: PlayerColor`
- `onExit: () => void` - Return to main menu

This component manages screen flow using AnimatePresence mode="wait":

1. **Subscribe to gauntlet store**:
   - `screen` state determines which screen to show
   - `playerDiceCount`, `streak`, `currentRound`, `currentOpponentName`, `currentPersonalityId`

2. **Screen flow** (per RESEARCH.md Pattern 1):
```typescript
<AnimatePresence mode="wait">
  {screen === 'rules' && <RulesScreen key="rules" ... />}
  {screen === 'fightCard' && <FightCard key="fightCard" ... />}
  {screen === 'gameplay' && <GauntletGameplay key="gameplay" ... />}
  {screen === 'victory' && <VictorySplash key="victory" ... />}
  {screen === 'gameOver' && <GameOverScreen key="gameOver" ... />}
</AnimatePresence>
```

3. **Wrap each screen in motion.div with transitions**:
   - initial: { opacity: 0, y: 50 }
   - animate: { opacity: 1, y: 0 }
   - exit: { opacity: 0, y: -50 }
   - transition: { duration: 0.4 }

4. **Persistent StreakCounter overlay** (outside AnimatePresence):
   - Only show during 'gameplay' screen
   - Position: absolute top-4 right-4 z-50

5. **GauntletGameplay sub-component** (inline or separate):
   Create a simplified 1v1 game component that:
   - Uses single-player game logic from page.tsx as reference
   - Single AI opponent with personality from gauntlet store
   - AI always starts with 5 dice (GAUN-04)
   - Player starts with playerDiceCount from gauntlet store (GAUN-03)
   - On player victory: call `winDuel()` which sets screen to 'victory'
   - On player defeat (loses all dice): store updates screen to 'gameOver'
   - Syncs playerDiceCount back to store after each round within the duel

   For initial implementation, you can:
   - Extract the core game loop from page.tsx into a reusable pattern
   - OR create a simplified version that handles 1v1 specifically
   - Key difference from regular single-player: no "Play Again" at end, flow continues via store

6. **Screen transition handlers**:
   - RulesScreen.onEnter -> startGauntlet() (which sets screen to 'fightCard')
   - FightCard.onDismiss -> startDuel() (sets screen to 'gameplay')
   - VictorySplash.onContinue -> showFightCard() (sets screen to 'fightCard', selects next opponent)
   - GameOverScreen.onRestart -> restartGauntlet()
   - GameOverScreen.onExit -> onExit prop (return to menu)

7. **Escalating AI difficulty** (GAUN-05):
   When selecting opponent, use the store's selectOpponentForRound() which returns:
   - Rounds 1-3: 'turtle' personality
   - Rounds 4-6: 'calculator' personality
   - Rounds 7+: 'shark' personality

Update `src/components/gauntlet/index.ts` to export GauntletModeScreen.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>GauntletModeScreen orchestrates full flow: rules -> fightCard -> gameplay -> victory/gameOver with AnimatePresence transitions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Gauntlet mode in page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
Update the main page.tsx to support Gauntlet mode as a game state.

1. **Add 'Gauntlet' to GameState type** (if not already):
   The GameState type in lib/types.ts or locally - add 'Gauntlet' option

2. **Add handleSelectGauntlet callback**:
```typescript
const handleSelectGauntlet = useCallback(() => {
  setGameState('Gauntlet');
}, []);
```

3. **Pass onSelectGauntlet to ModeSelection**:
```tsx
<ModeSelection
  onSelectAI={handleSelectAI}
  onSelectMultiplayer={handleSelectMultiplayer}
  onSelectGauntlet={handleSelectGauntlet}
  playerColor={playerColor}
/>
```

4. **Add handleExitGauntlet callback**:
```typescript
const handleExitGauntlet = useCallback(() => {
  setGameState('ModeSelection');
  // Reset gauntlet store if needed
  useGauntletStore.getState().exitToMenu();
}, []);
```

5. **Render GauntletModeScreen when gameState is 'Gauntlet'**:
```tsx
{gameState === 'Gauntlet' && (
  <GauntletModeScreen
    playerColor={playerColor}
    onExit={handleExitGauntlet}
  />
)}
```

6. **Import GauntletModeScreen**:
```typescript
import { GauntletModeScreen } from '@/components/gauntlet';
```

7. **Ensure gauntlet state initializes correctly**:
   When entering Gauntlet mode, the GauntletModeScreen should handle calling startGauntlet() from the rules screen, not automatically on mount.

This integrates Gauntlet as a top-level game mode alongside SinglePlayer and Multiplayer.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`. Start dev server and verify Gauntlet option appears in menu.</verify>
  <done>Gauntlet mode accessible from main menu, GauntletModeScreen renders when selected</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Gauntlet mode with sequential 1v1 duels, persistent dice, escalating difficulty, and cinematic transitions</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000
3. Verify "The Gauntlet" option appears as third button in mode selection (equal visual weight)
4. Click "The Gauntlet" - should see Rules screen with:
   - "THE GAUNTLET" title
   - Three rules about persistent dice, opponent dice, escalating difficulty
   - "Enter the Gauntlet" button
5. Click "Enter the Gauntlet" - should see Fight Card with:
   - "ROUND 1" header
   - Random AI opponent name
   - "Turtle" personality (Easy difficulty for round 1-3)
   - Flavor quote
   - Card is dismissible by click
6. Click to dismiss - should enter 1v1 gameplay:
   - Player has 5 dice
   - AI opponent has 5 dice
   - Streak counter visible in top corner showing "0 Defeated"
7. Win the duel - should see Victory Splash:
   - "{Opponent name} Defeated"
   - Streak shows "1"
   - Ominous message ("One down, many to go...")
8. Continue - should see next Fight Card:
   - "ROUND 2" header
   - New opponent
   - Still "Turtle" personality
9. Win a few duels and verify:
   - Player dice count persists (if you lost 2 dice in round 1, you start round 2 with 3)
   - Streak counter increments with bump animation
   - At round 4+, opponents become "Calculator" personality
   - At round 7+, opponents become "Shark" personality
10. Intentionally lose all dice - should see Game Over screen:
    - "THE GAUNTLET CLAIMS ANOTHER..."
    - Final streak count
    - "Enter the Gauntlet Again" button (prominent)
    - "Return to Menu" option
11. Click "Enter the Gauntlet Again" - should restart with full 5 dice
12. Click "Return to Menu" - should return to mode selection

Report any issues with:
- Transition animations (should be smooth, not instant)
- State persistence (dice carrying over correctly)
- AI difficulty (personality matches expected for round number)
- Visual styling (ominous tone, not celebratory)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run dev` - Dev server starts without errors
3. Full gauntlet flow works: menu -> rules -> fight card -> gameplay -> victory/defeat -> repeat/game over
4. All 12 requirements for Phase 20 addressed:
   - GAUN-01 through GAUN-08 (core loop)
   - TRAN-01 through TRAN-04 (transitions)
</verification>

<success_criteria>
- GAUN-01: Player starts Gauntlet from main menu (verified via mode selection)
- GAUN-02: Player plays 1v1 duels against AI (verified via gameplay)
- GAUN-03: Player dice carries over (verified by losing dice and checking next duel)
- GAUN-04: AI always starts with 5 dice (verified visually)
- GAUN-05: Difficulty escalates (Turtle -> Calculator -> Shark by round)
- GAUN-06: Streak counter displays (visible during gameplay)
- GAUN-07: Game ends on elimination (game over screen appears)
- GAUN-08: Immediate restart available (button on game over screen)
- TRAN-01: Victory splash shows defeated opponent
- TRAN-02: Round number displayed on fight card
- TRAN-03: Opponent introduction with personality flair
- TRAN-04: Animated transitions (AnimatePresence mode="wait")
</success_criteria>

<output>
After completion, create `.planning/phases/20-core-gauntlet-loop-transitions/20-03-SUMMARY.md`
</output>
