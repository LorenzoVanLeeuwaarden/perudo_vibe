---
phase: 06-game-state-sync
plan: 03
type: execute
wave: 3
depends_on: [06-02]
files_modified:
  - src/components/GameBoard.tsx
  - src/components/RevealPhase.tsx
  - src/app/room/[code]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Dudo/Calza overlay appears dramatically when challenge called"
    - "All dice are revealed after overlay dismisses"
    - "Matching dice are highlighted, others dimmed"
    - "Dramatic 3-4 second pause before showing result"
    - "Loser's die visually removed with animation"
    - "Winner/loser labels appear after pause"
    - "Next round starts after reveal completes"
  artifacts:
    - path: "src/components/RevealPhase.tsx"
      provides: "Reveal animation sequence component"
      min_lines: 80
    - path: "src/components/GameBoard.tsx"
      provides: "Integrated reveal flow"
      contains: "RevealPhase"
  key_links:
    - from: "src/components/GameBoard.tsx"
      to: "src/components/RevealPhase.tsx"
      via: "conditional render during reveal phase"
      pattern: "phase.*reveal.*RevealPhase"
    - from: "src/components/RevealPhase.tsx"
      to: "uiStore.revealedHands"
      via: "zustand store access"
      pattern: "useUIStore.*revealedHands"
---

<objective>
Implement the dramatic reveal experience for Dudo/Calza challenges with proper animation sequencing.

Purpose: The reveal is the climactic moment of each round. Per CONTEXT.md, it should feel like a "dramatic moment" with a 3-4 second pause before showing results. This plan implements the full reveal flow: overlay, dice reveal, matching highlight, result display, die removal animation.

Output: RevealPhase component that orchestrates the reveal sequence, integrated into GameBoard for seamless transitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-game-state-sync/06-CONTEXT.md
@.planning/phases/06-game-state-sync/06-02-SUMMARY.md

# Key source files
@src/components/GameBoard.tsx
@src/components/DudoOverlay.tsx
@src/components/PlayerRevealCard.tsx
@src/components/DyingDie.tsx
@src/stores/uiStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RevealPhase component</name>
  <files>src/components/RevealPhase.tsx</files>
  <action>
Create src/components/RevealPhase.tsx as a 'use client' component.

Props interface:
```typescript
interface RevealPhaseProps {
  players: ServerPlayer[];
  revealedHands: Record<string, number[]>;
  roundResult: {
    bid: Bid;
    actualCount: number;
    loserId: string | null;
    winnerId: string | null;
    isCalza: boolean;
  };
  onContinue: () => void; // Called when reveal sequence completes
}
```

Animation sequence (use useEffect with timeouts or Framer Motion's animate sequence):
1. **Phase 0: Initial** (0ms) - All hands hidden, DudoOverlay still visible
2. **Phase 1: Overlay dismisses** (1500ms) - DudoOverlay exits, hands start revealing
3. **Phase 2: Dice reveal** (1500-2500ms) - Each player's dice appear sequentially
4. **Phase 3: Highlight matching** (2500-3500ms) - Dice matching the bid value glow, others dim
5. **Phase 4: Count display** (3500-4500ms) - Show "X found" vs "Y bid" comparison
6. **Phase 5: Result** (4500-6000ms) - Show winner/loser with labels
7. **Phase 6: Die removal** (6000-7000ms) - Animate loser's die flying off screen
8. **Phase 7: Continue prompt** (7000ms+) - Show "Continue" button or auto-continue

Use useState for revealPhase: 0-7 to track sequence progress.

Layout:
- Full screen overlay (similar to reveal screen in single-player)
- Grid of PlayerRevealCard components (use existing component)
- Center area shows bid and actual count comparison
- Result banner shows who won/lost

Use existing components:
- PlayerRevealCard for each player's revealed dice
- DyingDie for the removed die animation
- Dice for highlighted matching dice

Styling:
- Dark backdrop with blur
- Cards for each player with their revealed dice
- Matching dice have glow effect, others are dimmed
- Use colorConfig from PLAYER_COLORS for player-specific colors
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>RevealPhase component created with timed animation sequence for dramatic reveal.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate RevealPhase into GameBoard</name>
  <files>src/components/GameBoard.tsx, src/app/room/[code]/page.tsx</files>
  <action>
In src/components/GameBoard.tsx:

1. Import RevealPhase component
2. Import useUIStore to access revealedHands, roundResult, showDudoOverlay
3. Add conditional render for reveal phase:

```typescript
const { showDudoOverlay, revealedHands, roundResult, setDudoOverlay, setRevealedHands, setRoundResult } = useUIStore();
const gameState = roomState.gameState;

// During reveal phase, show RevealPhase instead of normal game UI
if (gameState?.phase === 'reveal' && revealedHands && roundResult) {
  return (
    <>
      <DudoOverlay
        isVisible={showDudoOverlay}
        type={roundResult.isCalza ? 'calza' : 'dudo'}
        callerName={/* find caller name from players */}
        callerColor={/* find caller color */}
        onComplete={() => setDudoOverlay(false)}
      />
      <RevealPhase
        players={gameState.players}
        revealedHands={revealedHands}
        roundResult={roundResult}
        onContinue={handleContinueRound}
      />
    </>
  );
}
```

4. Add handleContinueRound function:
```typescript
const handleContinueRound = () => {
  // Clear reveal state
  setRevealedHands(null);
  setRoundResult(null);
  // Send continue message to server
  sendMessage({ type: 'CONTINUE_ROUND', timestamp: Date.now() });
};
```

In src/app/room/[code]/page.tsx:

Ensure ROUND_RESULT handler properly sets up the reveal:
- Sets showDudoOverlay to false after short delay (overlay has its own exit animation)
- Sets revealedHands with message.allHands
- Sets roundResult with bid, actualCount, loserId, winnerId, isCalza

Add callerId tracking for overlay display:
- Add callerInfo state: { id: string; name: string; color: PlayerColor } | null
- Set on DUDO_CALLED/CALZA_CALLED, clear after reveal
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>GameBoard conditionally renders RevealPhase during reveal, handles continue flow.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full game loop</name>
  <what-built>
Complete game state synchronization flow:
1. Server handlers for all game actions (Plan 01)
2. Client message handling and GameBoard UI (Plan 02)
3. Reveal animation sequence (Plan 03)
  </what-built>
  <how-to-verify>
1. Start the dev server: npm run dev
2. Start PartyKit in another terminal: npx partykit dev
3. Open two browser tabs to http://localhost:3000
4. In both tabs:
   a. Select "Play with Friends"
   b. One creates room, other joins via link
   c. Both enter nicknames and join
5. Host clicks "Start Game"
6. Verify BOTH players:
   - See their own dice (should be different for each player)
   - See the same current bid in center
   - See turn indicator showing whose turn
7. Current player places a bid - verify it appears for both players
8. Continue bidding a few rounds
9. Call Dudo - verify:
   - DUDO! overlay appears dramatically for both
   - After overlay, all dice are revealed
   - Matching dice are highlighted
   - Result shows who won/lost
   - Loser's die count decreases
10. Click Continue - verify new round starts
11. Play until someone is eliminated - verify they appear dimmed
12. Play until one player wins - verify game ends

Focus areas:
- Dice privacy: Can you see the other player's dice BEFORE reveal? (should not)
- Sync: Is the bid display the same for both players?
- Turn indication: Does it correctly show whose turn it is?
- Reveal timing: Is there a dramatic pause before showing result?
  </how-to-verify>
  <resume-signal>Type "approved" if game loop works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should complete with no errors
2. Human verification of full game loop per checkpoint task
</verification>

<success_criteria>
- RevealPhase component shows dramatic reveal sequence
- DudoOverlay appears on challenge call
- All dice revealed after overlay dismisses
- Matching dice highlighted, others dimmed
- 3-4 second pause before showing result
- Winner/loser clearly indicated
- Die removal animation plays
- Continue button starts next round
- Full game loop works with 2 players
- Dice remain private until reveal
</success_criteria>

<output>
After completion, create `.planning/phases/06-game-state-sync/06-03-SUMMARY.md`
</output>
