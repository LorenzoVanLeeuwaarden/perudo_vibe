---
phase: 04-join-flow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - package.json
  - src/app/layout.tsx
  - src/components/JoinForm.tsx
  - src/components/RoomLobby.tsx
  - src/app/room/[code]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User opening room link sees nickname entry form with room info"
    - "User can enter 2-12 character nickname and join"
    - "Real-time character counter shows current/max (e.g., '4/12')"
    - "Form pre-fills saved nickname from localStorage"
    - "Returning user (same browser) skips form and auto-joins"
    - "Toast notification shows when player joins"
    - "Smooth transition from join form to lobby"
  artifacts:
    - path: "src/components/JoinForm.tsx"
      provides: "Nickname entry form with validation"
      exports: ["JoinForm"]
    - path: "src/app/room/[code]/page.tsx"
      provides: "Join flow state machine"
      contains: "AnimatePresence"
    - path: "src/app/layout.tsx"
      provides: "Toast provider"
      contains: "Toaster"
  key_links:
    - from: "src/app/room/[code]/page.tsx"
      to: "useClientIdentity"
      via: "hook call for persistent ID"
      pattern: "useClientIdentity"
    - from: "src/app/room/[code]/page.tsx"
      to: "ROOM_INFO handler"
      via: "onMessage switch case"
      pattern: "case.*ROOM_INFO"
    - from: "src/components/JoinForm.tsx"
      to: "uiStore.playerName"
      via: "pre-fill from persisted store"
      pattern: "useUIStore"

user_setup: []
---

<objective>
Client-side join flow UI with JoinForm, state machine, and toast notifications

Purpose: Enable users to join rooms via shareable links with a polished UX - nickname entry form with validation, room info preview, loading states, error handling, and smooth transitions between join form and lobby.

Output: Complete join flow where users see room info, enter nickname, get validated, and transition to lobby with toast notifications for other players.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-join-flow/04-CONTEXT.md
@.planning/phases/04-join-flow/04-RESEARCH.md
@.planning/phases/04-join-flow/04-01-SUMMARY.md

# Existing code to extend
@src/app/layout.tsx
@src/app/room/[code]/page.tsx
@src/components/RoomLobby.tsx
@src/stores/uiStore.ts
@src/hooks/useClientIdentity.ts
@src/hooks/useRoomConnection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner and add Toaster to layout</name>
  <files>
    package.json
    src/app/layout.tsx
  </files>
  <action>
1. Install sonner:
```bash
npm install sonner
```

2. Add Toaster component to layout.tsx:

In `src/app/layout.tsx`, add the Toaster component inside the body, after children:

```typescript
import { Toaster } from 'sonner';

// In the return, inside <body>:
<body className={/* existing classes */}>
  {children}
  <Toaster
    position="top-center"
    toastOptions={{
      style: {
        background: 'rgba(26, 11, 46, 0.95)',
        border: '1px solid rgba(139, 92, 246, 0.3)',
        color: '#e8e6f2',
      },
    }}
  />
</body>
```

The toast styling matches the existing retro-panel aesthetic with purple-deep background and purple-mid border.
  </action>
  <verify>
    - `npm ls sonner` shows the package installed
    - `grep -r "Toaster" src/app/layout.tsx` finds the component
    - `npm run dev` starts without errors
  </verify>
  <done>
    sonner installed and Toaster configured with matching theme in layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JoinForm component with validation</name>
  <files>src/components/JoinForm.tsx</files>
  <action>
Create `src/components/JoinForm.tsx` with:

1. Props interface:
```typescript
interface JoinFormProps {
  roomCode: string;
  roomInfo: { playerCount: number; maxPlayers: number } | null;
  isLoading: boolean;
  error: string | null;
  onSubmit: (nickname: string) => void;
}
```

2. Component features:
- Pre-fill nickname from uiStore.playerName
- Real-time character counter showing "N/12"
- Counter turns red when invalid (< 2 or > 12)
- Input auto-focused on mount
- Enter key submits form
- Button disabled when invalid or loading
- Loading state shows spinner + "Joining..."
- Error message displayed below input
- Room code displayed prominently at top
- Player count shown below code (e.g., "3/6 players")

3. Use grapheme-aware length for emoji support:
```typescript
const charCount = [...localName].length; // Handles emoji correctly
```

4. Style to match existing design system:
- Uses existing Tailwind classes (purple-deep, purple-mid, gold-accent, etc.)
- Input styled like existing form inputs
- Button styled like CTA buttons in project

Full component structure:
```typescript
'use client';

import { useState, useCallback, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Loader2 } from 'lucide-react';
import { useUIStore } from '@/stores/uiStore';

interface JoinFormProps {
  roomCode: string;
  roomInfo: { playerCount: number; maxPlayers: number } | null;
  isLoading: boolean;
  error: string | null;
  onSubmit: (nickname: string) => void;
}

export function JoinForm({ roomCode, roomInfo, isLoading, error, onSubmit }: JoinFormProps) {
  const { playerName, setPlayerName } = useUIStore();
  const [localName, setLocalName] = useState('');
  const [hasHydrated, setHasHydrated] = useState(false);

  // Pre-fill from store after hydration (avoid SSR mismatch)
  useEffect(() => {
    if (!hasHydrated) {
      setLocalName(playerName);
      setHasHydrated(true);
    }
  }, [playerName, hasHydrated]);

  const charCount = [...localName].length; // Grapheme-aware for emoji
  const isValid = charCount >= 2 && charCount <= 12;

  const handleSubmit = useCallback((e: React.FormEvent) => {
    e.preventDefault();
    if (isValid && !isLoading) {
      const trimmed = localName.trim();
      setPlayerName(trimmed); // Persist for next time
      onSubmit(trimmed);
    }
  }, [isValid, isLoading, localName, setPlayerName, onSubmit]);

  return (
    <motion.form
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3 }}
      onSubmit={handleSubmit}
      className="retro-panel p-8 w-full max-w-md space-y-6"
    >
      {/* Room info header */}
      <div className="text-center">
        <p className="text-white-soft/60 text-sm mb-1">Joining Room</p>
        <p className="text-4xl font-mono font-bold tracking-widest text-gold-accent">
          {roomCode}
        </p>
        {roomInfo ? (
          <p className="text-white-soft/50 text-sm mt-2">
            {roomInfo.playerCount} / {roomInfo.maxPlayers} players
          </p>
        ) : (
          <p className="text-white-soft/30 text-sm mt-2">Loading room info...</p>
        )}
      </div>

      {/* Nickname input */}
      <div>
        <label htmlFor="nickname" className="block text-white-soft/80 text-sm mb-2">
          Choose your nickname
        </label>
        <input
          id="nickname"
          type="text"
          value={localName}
          onChange={(e) => setLocalName(e.target.value)}
          placeholder="Enter nickname"
          autoFocus
          autoComplete="off"
          disabled={isLoading}
          className="w-full px-4 py-3 bg-purple-deep/60 border border-purple-mid rounded-lg text-white-soft placeholder:text-white-soft/30 focus:outline-none focus:border-gold-accent/50 focus:ring-1 focus:ring-gold-accent/30 transition-colors disabled:opacity-50"
        />
        <div className="flex justify-between items-center mt-1">
          <span
            className={`text-xs ${
              charCount > 0 && (charCount < 2 || charCount > 12)
                ? 'text-red-danger'
                : 'text-white-soft/40'
            }`}
          >
            {charCount}/12
          </span>
          {charCount > 0 && charCount < 2 && (
            <span className="text-xs text-red-danger">Too short</span>
          )}
          {charCount > 12 && (
            <span className="text-xs text-red-danger">Too long</span>
          )}
        </div>
      </div>

      {/* Error message */}
      {error && (
        <motion.p
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-red-danger text-sm text-center bg-red-danger/10 py-2 px-3 rounded-lg border border-red-danger/20"
        >
          {error}
        </motion.p>
      )}

      {/* Submit button */}
      <motion.button
        type="submit"
        disabled={!isValid || isLoading}
        whileHover={isValid && !isLoading ? { scale: 1.02 } : {}}
        whileTap={isValid && !isLoading ? { scale: 0.98 } : {}}
        className="w-full py-3 bg-gold-accent text-purple-deep font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-opacity flex items-center justify-center gap-2"
      >
        {isLoading ? (
          <>
            <Loader2 className="w-5 h-5 animate-spin" />
            Joining...
          </>
        ) : (
          'Join Game'
        )}
      </motion.button>
    </motion.form>
  );
}
```
  </action>
  <verify>
    - `npm run lint` passes
    - File exports JoinForm component
    - Component uses useUIStore for playerName persistence
  </verify>
  <done>
    JoinForm component created with nickname input, character counter, validation, loading state, and error display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement join flow state machine in room page</name>
  <files>
    src/app/room/[code]/page.tsx
    src/components/RoomLobby.tsx
  </files>
  <action>
1. Rewrite `src/app/room/[code]/page.tsx` with join flow state machine:

State machine:
- `connecting`: WebSocket connecting, show loading
- `room-info`: Got ROOM_INFO, show join form
- `joining`: Sent JOIN_ROOM, waiting for response
- `joined`: Got ROOM_STATE, show lobby
- `error`: Error occurred, show error state

Key behaviors:
- Use useClientIdentity for persistent ID
- Only connect when clientId is available (after hydration)
- Handle ROOM_INFO -> show join form
- Handle ROOM_STATE -> show lobby (also handles returning user auto-join)
- Handle PLAYER_JOINED -> toast notification
- Handle ERROR -> show in join form or error page
- AnimatePresence for smooth transitions

```typescript
'use client';

import { useParams, useRouter } from 'next/navigation';
import { useState, useCallback, useEffect } from 'react';
import { AnimatePresence, motion } from 'framer-motion';
import { toast } from 'sonner';
import { ArrowLeft, AlertCircle, Loader2 } from 'lucide-react';
import { normalizeRoomCode } from '@/lib/roomCode';
import { useClientIdentity } from '@/hooks/useClientIdentity';
import { useRoomConnection, type ConnectionStatus } from '@/hooks/useRoomConnection';
import { useUIStore } from '@/stores/uiStore';
import { JoinForm } from '@/components/JoinForm';
import { RoomLobby } from '@/components/RoomLobby';
import { CasinoLogo } from '@/components/CasinoLogo';
import { ShaderBackground } from '@/components/ShaderBackground';
import type { ServerMessage, ServerRoomState } from '@/shared';

type JoinState =
  | { status: 'connecting' }
  | { status: 'room-info'; info: { playerCount: number; maxPlayers: number; gameInProgress: boolean } }
  | { status: 'joining' }
  | { status: 'joined'; roomState: ServerRoomState; playerId: string }
  | { status: 'error'; message: string };

export default function RoomPage() {
  const params = useParams();
  const router = useRouter();
  const code = params.code as string;
  const roomCode = normalizeRoomCode(code || '');

  const clientId = useClientIdentity();
  const { playerColor, clearPreferredMode } = useUIStore();

  const [joinState, setJoinState] = useState<JoinState>({ status: 'connecting' });
  const [joinError, setJoinError] = useState<string | null>(null);
  const [wsRef, setWsRef] = useState<{ send: (data: string) => void } | null>(null);

  const handleMessage = useCallback((message: ServerMessage) => {
    switch (message.type) {
      case 'ROOM_INFO':
        // New user - show join form
        if (message.gameInProgress) {
          setJoinState({ status: 'error', message: 'Game in progress. Wait until it ends.' });
        } else {
          setJoinState({
            status: 'room-info',
            info: {
              playerCount: message.playerCount,
              maxPlayers: message.maxPlayers,
              gameInProgress: message.gameInProgress,
            },
          });
        }
        break;

      case 'ROOM_STATE':
        // Joined or returning user
        setJoinState({
          status: 'joined',
          roomState: message.state,
          playerId: message.yourPlayerId,
        });
        setJoinError(null);
        break;

      case 'PLAYER_JOINED':
        // Another player joined
        toast.success(`${message.player.name} joined`);
        // Update room state if we have it
        setJoinState(prev => {
          if (prev.status === 'joined') {
            return {
              ...prev,
              roomState: {
                ...prev.roomState,
                players: [...prev.roomState.players, message.player],
              },
            };
          }
          return prev;
        });
        break;

      case 'PLAYER_LEFT':
        // Player left
        setJoinState(prev => {
          if (prev.status === 'joined') {
            const player = prev.roomState.players.find(p => p.id === message.playerId);
            if (player && message.reason !== 'disconnected') {
              toast.info(`${player.name} left`);
            }
            return {
              ...prev,
              roomState: {
                ...prev.roomState,
                players: prev.roomState.players.filter(p => p.id !== message.playerId),
              },
            };
          }
          return prev;
        });
        break;

      case 'PLAYER_RECONNECTED':
        toast.success(`${message.playerName} reconnected`);
        break;

      case 'ERROR':
        // Handle errors
        if (message.error.type === 'INVALID_NAME' || message.error.type === 'ROOM_FULL') {
          setJoinError(message.error.reason);
          // Go back to room-info state to show form with error
          setJoinState(prev => {
            if (prev.status === 'joining') {
              return { status: 'room-info', info: { playerCount: 0, maxPlayers: 6, gameInProgress: false } };
            }
            return prev;
          });
        } else if (message.error.type === 'INVALID_ACTION') {
          setJoinState({ status: 'error', message: message.error.reason });
        }
        break;
    }
  }, []);

  // Connection hook - only connect when we have clientId
  const { ws, status } = useRoomConnection({
    roomCode,
    clientId: clientId ?? undefined,
    onMessage: handleMessage,
  });

  // Store ws reference for sending messages
  useEffect(() => {
    if (ws) {
      setWsRef(ws);
    }
  }, [ws]);

  // Update room info player count when someone joins (for form)
  useEffect(() => {
    if (joinState.status === 'room-info') {
      // Refresh on PLAYER_JOINED handled in message handler
    }
  }, [joinState]);

  const handleJoinSubmit = useCallback((nickname: string) => {
    if (!wsRef) return;

    setJoinState({ status: 'joining' });
    setJoinError(null);

    wsRef.send(JSON.stringify({
      type: 'JOIN_ROOM',
      playerName: nickname,
      timestamp: Date.now(),
    }));
  }, [wsRef]);

  const handleBack = useCallback(() => {
    clearPreferredMode();
    router.push('/');
  }, [clearPreferredMode, router]);

  // Loading state while client ID initializes
  if (!clientId) {
    return (
      <main className="min-h-screen flex items-center justify-center">
        <ShaderBackground />
        <div className="scanlines-overlay" />
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="flex flex-col items-center gap-4"
        >
          <Loader2 className="w-8 h-8 animate-spin text-gold-accent" />
          <p className="text-white-soft/60">Connecting...</p>
        </motion.div>
      </main>
    );
  }

  // Error state
  if (joinState.status === 'error') {
    return (
      <main className="min-h-screen flex flex-col items-center justify-center p-8 relative">
        <ShaderBackground />
        <div className="scanlines-overlay" />
        <div className="relative z-10 flex flex-col items-center max-w-md w-full text-center">
          <CasinoLogo color={playerColor} />
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="retro-panel p-8 mt-8 w-full"
          >
            <AlertCircle className="w-12 h-12 text-red-danger mx-auto mb-4" />
            <h2 className="text-xl font-bold text-white-soft mb-2">Cannot Join Room</h2>
            <p className="text-white-soft/60 mb-6">{joinState.message}</p>
            <motion.button
              onClick={handleBack}
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 0.98 }}
              className="w-full py-3 bg-gold-accent text-purple-deep font-bold rounded-lg"
            >
              Back to Home
            </motion.button>
          </motion.div>
        </div>
      </main>
    );
  }

  // Joined state - show lobby
  if (joinState.status === 'joined') {
    return (
      <RoomLobby
        roomCode={roomCode}
        roomState={joinState.roomState}
        myPlayerId={joinState.playerId}
        connectionStatus={status}
      />
    );
  }

  // Join form state
  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-8 relative">
      <ShaderBackground />
      <div className="scanlines-overlay" />

      {/* Back button */}
      <motion.button
        initial={{ opacity: 0, x: -20 }}
        animate={{ opacity: 1, x: 0 }}
        whileHover={{ scale: 1.05, x: -2 }}
        whileTap={{ scale: 0.95 }}
        onClick={handleBack}
        className="fixed top-4 left-4 z-50 px-4 py-2 rounded-lg bg-purple-deep/90 border border-purple-mid text-white-soft/70 flex items-center gap-2 hover:bg-purple-mid/50 transition-colors backdrop-blur-sm"
      >
        <ArrowLeft className="w-4 h-4" />
        Back
      </motion.button>

      <div className="relative z-10 flex flex-col items-center max-w-md w-full">
        <motion.div
          initial={{ opacity: 0, y: -30 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <CasinoLogo color={playerColor} />
        </motion.div>

        <AnimatePresence mode="wait">
          {(joinState.status === 'connecting' || joinState.status === 'joining') && (
            <motion.div
              key="loading"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="retro-panel p-8 w-full flex flex-col items-center"
            >
              <Loader2 className="w-8 h-8 animate-spin text-gold-accent mb-4" />
              <p className="text-white-soft/60">
                {joinState.status === 'connecting' ? 'Connecting to room...' : 'Joining...'}
              </p>
            </motion.div>
          )}

          {joinState.status === 'room-info' && (
            <JoinForm
              key="join-form"
              roomCode={roomCode}
              roomInfo={joinState.info}
              isLoading={false}
              error={joinError}
              onSubmit={handleJoinSubmit}
            />
          )}
        </AnimatePresence>
      </div>
    </main>
  );
}
```

2. Update `src/components/RoomLobby.tsx` to accept room state as props:

Change the interface and remove internal connection logic (now handled by parent):

```typescript
interface RoomLobbyProps {
  roomCode: string;
  roomState: ServerRoomState;
  myPlayerId: string;
  connectionStatus: ConnectionStatus;
}

export function RoomLobby({ roomCode, roomState, myPlayerId, connectionStatus }: RoomLobbyProps) {
  // Remove useRoomConnection hook - connection handled by parent
  // Use roomState and myPlayerId from props
  // Keep connection status display
  // Keep RoomShare component
  // Update waiting message to show player count from roomState.players

  const router = useRouter();
  const { playerColor, clearPreferredMode } = useUIStore();
  const colorConfig = PLAYER_COLORS[playerColor];

  const handleBack = () => {
    clearPreferredMode();
    router.push('/');
  };

  const connectedPlayers = roomState.players.filter(p => p.isConnected);

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-8 relative">
      {/* ... existing ShaderBackground and scanlines ... */}

      {/* Back button - same as before */}

      {/* Connection status - use connectionStatus prop */}

      <div className="relative z-10 flex flex-col items-center max-w-md w-full">
        {/* Logo */}
        <motion.div ...>
          <CasinoLogo color={playerColor} />
        </motion.div>

        {/* Lobby panel */}
        <motion.div ... className="retro-panel p-8 w-full">
          <RoomShare roomCode={roomCode} playerColor={playerColor} />

          {/* Player count */}
          <div className="mt-6 text-center">
            <p className="text-white-soft/80 text-sm">
              {connectedPlayers.length} / 6 players
            </p>
          </div>

          {/* Waiting message */}
          <motion.div ... className="mt-4 text-center">
            <p className="text-white-soft/60 text-sm">
              {connectedPlayers.length < 2
                ? 'Waiting for players to join...'
                : `${connectedPlayers.length} players ready`
              }
            </p>
            {/* ... existing loading animation ... */}
          </motion.div>
        </motion.div>
      </div>
    </main>
  );
}
```

Add import for ConnectionStatus type from hooks and ServerRoomState from shared.
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` completes without errors
    - Run `npm run dev` and `npx partykit dev` in separate terminals
  </verify>
  <done>
    Room page implements join flow state machine with connecting, room-info (join form), joining, joined (lobby), and error states. RoomLobby updated to receive state from parent.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete join flow: client identity persistence, server validation, JoinForm with validation, state machine transitions, toast notifications, and AnimatePresence transitions.
  </what-built>
  <how-to-verify>
Test the complete join flow:

1. Start both servers:
   - Terminal 1: `npm run dev` (Next.js on localhost:3000)
   - Terminal 2: `npx partykit dev` (PartyKit on localhost:1999)

2. Create a room:
   - Go to http://localhost:3000
   - Click "Play with Friends"
   - Note the room code shown

3. Join as another user (incognito/different browser):
   - Open the room URL (e.g., http://localhost:3000/room/X7KM3P)
   - Verify: Join form shows with room code and "0/6 players" initially
   - Verify: Character counter shows as you type
   - Verify: Button disabled when < 2 chars or > 12 chars
   - Enter a nickname (e.g., "Player2") and click "Join Game"
   - Verify: Loading state shows "Joining..."
   - Verify: Transitions smoothly to lobby view

4. Check first player sees toast:
   - In the original browser (room creator)
   - Verify: Toast notification appears "Player2 joined"

5. Test duplicate nickname:
   - Open another incognito window to same room
   - Try to join with same nickname as existing player
   - Verify: Error message "This name is taken. Choose another."

6. Test returning user:
   - In the second browser window (Player2), refresh the page
   - Verify: Automatically rejoins without showing join form
   - Verify: Original browser shows "Player2 reconnected" toast

7. Test pre-filled nickname:
   - Close the incognito window
   - Open a new incognito window to the same room
   - Verify: Join form shows (new session = new client ID)
   - But if same browser (not incognito), nickname should be pre-filled

Expected outcome: Full join flow works with validation, real-time updates, and smooth UX.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run lint` passes
2. `npm run build` completes without TypeScript errors
3. Full join flow works: form -> validation -> join -> lobby
4. Toast notifications appear when players join/reconnect
5. Returning users auto-rejoin
6. Duplicate nickname validation works
7. Room info (player count) displays correctly
</verification>

<success_criteria>
- User opening room link sees join form with room code and player count
- Nickname input has real-time character counter (N/12)
- Counter and validation message turn red when invalid
- Previously used nickname pre-fills from localStorage
- "Join Game" button disabled when invalid or loading
- Loading state shows spinner and "Joining..."
- Smooth AnimatePresence transition to lobby after join
- Toast notification when another player joins
- Returning user (same browser) auto-joins without form
- Duplicate nickname shows "This name is taken" error
- Game in progress shows error page
</success_criteria>

<output>
After completion, create `.planning/phases/04-join-flow/04-02-SUMMARY.md`
</output>
