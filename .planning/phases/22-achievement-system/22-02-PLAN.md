---
phase: 22-achievement-system
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/gauntlet/AchievementToast.tsx
  - src/components/gauntlet/index.ts
  - src/stores/gauntletStore.ts
  - src/components/gauntlet/GauntletGameplay.tsx
  - src/components/gauntlet/GauntletModeScreen.tsx
autonomous: true

must_haves:
  truths:
    - "Achievement toast appears when milestone reached"
    - "Toast shows achievement name, icon, and brief animation"
    - "Hidden achievements trigger toast on special conditions"
    - "Run stats are tracked during gameplay"
  artifacts:
    - path: "src/components/gauntlet/AchievementToast.tsx"
      provides: "Toast notification component"
      min_lines: 60
    - path: "src/components/gauntlet/GauntletGameplay.tsx"
      provides: "Achievement detection during gameplay"
      contains: "useAchievementStore"
  key_links:
    - from: "src/components/gauntlet/GauntletGameplay.tsx"
      to: "src/stores/achievementStore.ts"
      via: "imports and uses store"
      pattern: "useAchievementStore"
    - from: "src/components/gauntlet/GauntletModeScreen.tsx"
      to: "src/components/gauntlet/AchievementToast.tsx"
      via: "renders toast component"
      pattern: "AchievementToast"
---

<objective>
Implement achievement detection logic and toast notifications. Track run statistics and trigger achievements at the right moments.

Purpose: Make achievements actually unlock during gameplay with satisfying feedback.

Output: Toast component, detection logic in gameplay, and stat tracking integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-achievement-system/22-CONTEXT.md
@.planning/phases/22-achievement-system/22-01-SUMMARY.md

# Files to modify
@src/components/gauntlet/GauntletGameplay.tsx
@src/components/gauntlet/GauntletModeScreen.tsx
@src/stores/gauntletStore.ts

# Achievement system from Plan 01
@src/lib/achievements.ts
@src/stores/achievementStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Achievement toast component</name>
  <files>src/components/gauntlet/AchievementToast.tsx, src/components/gauntlet/index.ts</files>
  <action>
Create the achievement toast notification component:

1. AchievementToast component props:
   - achievement: Achievement | null (the achievement to display)
   - isVisible: boolean (controls show/hide)
   - onComplete: () => void (called when toast should hide)

2. Visual design (per CONTEXT.md decisions):
   - Position: top center of screen (fixed positioning)
   - Background: dark semi-transparent with golden/amber accent for milestone achievements
   - Different accent for hidden achievements (purple/mysterious)
   - Icon: Use lucide-react icon based on achievement.icon field
   - Text: Achievement name prominently, description smaller below

3. Animation (Framer Motion):
   - Entry: Scale from 0.8 to 1, opacity 0 to 1, slight y movement from -20 to 0
   - Pop effect: Brief scale overshoot (1.0 -> 1.1 -> 1.0) on entry
   - Exit: Fade out and slide up
   - Duration visible: 4-5 seconds (use setTimeout in component)
   - Respect useReducedMotion: simpler fade only

4. Sound placeholder:
   - Add comment for where unlock sound would play
   - Can use existing sound infrastructure pattern from useSoundEffects.ts

5. Export from index.ts
  </action>
  <verify>
    - Component compiles: `npx tsc --noEmit src/components/gauntlet/AchievementToast.tsx`
    - Export added to index.ts
  </verify>
  <done>
    - Toast component renders achievement info
    - Animated entry/exit with Framer Motion
    - Auto-hides after 4-5 seconds
    - Accessible (reduced motion respected)
  </done>
</task>

<task type="auto">
  <name>Task 2: Achievement detection and stat tracking</name>
  <files>src/components/gauntlet/GauntletGameplay.tsx, src/stores/gauntletStore.ts</files>
  <action>
Integrate achievement detection into gameplay:

1. In GauntletGameplay.tsx:
   - Import useAchievementStore
   - Track hidden achievement conditions during round resolution:
     a. When player calls DUDO correctly: incrementStat('correctDudoCalls')
     b. When opponent calls DUDO on player's TRUE bid: incrementStat('bluffWins')
     c. When player calls Calza successfully: incrementStat('calzaSuccesses')
     d. When player calls DUDO and actual count equals bid exactly: incrementStat('exactDudoCalls')

   - After round resolution, check hidden achievement thresholds:
     - If correctDudoCalls >= threshold: unlock 'truth-seeker'
     - If bluffWins >= threshold: unlock 'bold-bluffer'
     - etc.

   - On duel win, check risky victory achievements:
     - If playerDiceCount === 1 at win: unlock 'last-die-standing'
     - If player was 3+ dice behind at any point in duel and won: unlock 'comeback-kid'
       (This requires tracking max deficit during duel - add local state)

2. In gauntletStore.ts:
   - Add pendingAchievement: Achievement | null to state
   - Add setPendingAchievement(achievement: Achievement | null): void action
   - Add clearPendingAchievement(): void action
   - When winDuel() is called, check streak against milestones:
     - Import MILESTONE_ACHIEVEMENTS
     - If new streak matches any milestone threshold AND not already unlocked:
       - Call achievementStore.unlockAchievement(id)
       - Set pendingAchievement to the achievement

3. Reset run stats:
   - In startGauntlet() and restartGauntlet(): call achievementStore.resetRunStats()
  </action>
  <verify>
    - Files compile: `npx tsc --noEmit`
    - Detection logic present: grep for incrementStat calls
    - Milestone check present: grep for MILESTONE_ACHIEVEMENTS in gauntletStore
  </verify>
  <done>
    - Run stats tracked during gameplay
    - Hidden achievements checked after rounds
    - Milestone achievements checked on duel win
    - pendingAchievement state for toast display
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire toast into GauntletModeScreen</name>
  <files>src/components/gauntlet/GauntletModeScreen.tsx</files>
  <action>
Display achievement toasts from the orchestrator component:

1. Import AchievementToast component
2. Subscribe to gauntletStore.pendingAchievement
3. Render AchievementToast with:
   - achievement={pendingAchievement}
   - isVisible={pendingAchievement !== null}
   - onComplete={() => clearPendingAchievement()}

4. Position toast to appear above other UI:
   - Use z-index higher than game overlays (z-60 or similar)
   - Toast should be visible during victory splash and gameplay

5. Consider timing:
   - Milestone achievements: Show during victory splash transition
   - Hidden achievements: Can show during gameplay (after round resolution)
  </action>
  <verify>
    - Component compiles: `npx tsc --noEmit src/components/gauntlet/GauntletModeScreen.tsx`
    - Toast rendered: grep for AchievementToast in file
  </verify>
  <done>
    - Toast displays when pendingAchievement is set
    - Toast clears after animation completes
    - Proper z-index layering
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build`
2. Start dev server: `npm run dev`
3. Play gauntlet, defeat 5 opponents -> milestone toast appears
4. Verify toast auto-dismisses after 4-5 seconds
5. Achievement persists in localStorage after page refresh
</verification>

<success_criteria>
- Toast component with satisfying animation
- Milestone achievements trigger at 5, 10, 25, 50, 100
- Hidden achievements track via run stats
- Toast displays achievement name and icon
- Detection logic correctly identifies unlock conditions
</success_criteria>

<output>
After completion, create `.planning/phases/22-achievement-system/22-02-SUMMARY.md`
</output>
