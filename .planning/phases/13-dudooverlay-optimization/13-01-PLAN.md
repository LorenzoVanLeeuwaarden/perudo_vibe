---
phase: 13-dudooverlay-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/DudoOverlay.tsx
autonomous: false

must_haves:
  truths:
    - "Dudo/Calza overlay fades in smoothly at 60fps"
    - "Text glow pulses without frame drops"
    - "Impact effect is visually impactful without SVG filter lag"
    - "Particles burst outward smoothly"
  artifacts:
    - path: "src/components/DudoOverlay.tsx"
      provides: "GPU-optimized Dudo/Calza overlay animation"
      contains: "backdropFilter: 'blur(8px)'"
  key_links:
    - from: "DudoOverlay.tsx"
      to: "Framer Motion"
      via: "animate prop with transform/opacity only"
      pattern: "animate=\\{.*opacity.*\\}"
---

<objective>
Optimize DudoOverlay animations for 60fps performance by restricting all animations to GPU-accelerated properties (transform and opacity only).

Purpose: Fix the main performance culprits causing frame drops, especially in Firefox. The current implementation animates backdrop-filter, text-shadow, and uses an expensive SVG filter.

Output: Refactored DudoOverlay.tsx with smooth 60fps animations that maintain visual impact.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dudooverlay-optimization/13-RESEARCH.md

@src/components/DudoOverlay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor DudoOverlay for GPU-only animations</name>
  <files>src/components/DudoOverlay.tsx</files>
  <action>
Refactor DudoOverlay.tsx applying FOUR specific optimizations from the research:

**1. DUDO-01: Static backdrop-filter with opacity fade (lines 54-63)**

BEFORE:
```tsx
<motion.div
  initial={{ opacity: 0, backdropFilter: 'blur(0px)' }}
  animate={{ opacity: 1, backdropFilter: 'blur(8px)' }}
  exit={{ opacity: 0, backdropFilter: 'blur(0px)' }}
```

AFTER:
```tsx
<motion.div
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  exit={{ opacity: 0 }}
  style={{
    background: 'rgba(0, 0, 0, 0.6)',
    backdropFilter: 'blur(8px)',  // STATIC - never animated
  }}
```

**2. DUDO-02: Pseudo-element text glow (lines 139-161)**

Replace animated textShadow with a pseudo-element technique. Create a glow layer that animates ONLY opacity:

```tsx
{/* Glow layer - blurred duplicate that animates opacity only */}
<motion.span
  className="absolute inset-0 font-mono font-black text-8xl md:text-[12rem] uppercase tracking-tighter select-none pointer-events-none"
  style={{
    color: mainColor,
    filter: 'blur(20px)',  // Static blur
  }}
  animate={{ opacity: [0.4, 0.8, 0.4] }}  // Only opacity animates
  transition={{ duration: 1, repeat: 2 }}
  aria-hidden="true"
>
  {isDudo ? 'DUDO!' : 'CALZA!'}
</motion.span>

{/* Main text - STATIC text-shadow, no animation */}
<h1
  className="relative font-mono font-black text-8xl md:text-[12rem] uppercase tracking-tighter select-none"
  style={{
    color: mainColor,
    textShadow: `0 0 20px ${glowColor}, 0 0 40px ${glowColor}, 4px 4px 0 ${isDudo ? '#990033' : '#166534'}`,  // Static
  }}
>
  {isDudo ? 'DUDO!' : 'CALZA!'}
</h1>
```

The text container (motion.div at line 111) already correctly animates scale, opacity, rotate - KEEP those.

**3. DUDO-03: Replace SVG glitch filter with CSS-only (lines 186-212, 149)**

Remove the entire SVG filter definition (lines 186-212). Replace the showGlitch effect with CSS pseudo-element technique using transform and opacity only:

```tsx
{/* RGB Glitch layers - CSS only, animates transform/opacity */}
{showGlitch && (
  <>
    <motion.span
      className="absolute inset-0 font-mono font-black text-8xl md:text-[12rem] uppercase tracking-tighter select-none pointer-events-none"
      style={{ color: '#ff0000', mixBlendMode: 'screen' }}
      initial={{ opacity: 0, x: 0 }}
      animate={{ x: [-2, 2, -2], opacity: [0, 0.5, 0] }}
      transition={{ duration: 0.15 }}
      aria-hidden="true"
    >
      {isDudo ? 'DUDO!' : 'CALZA!'}
    </motion.span>
    <motion.span
      className="absolute inset-0 font-mono font-black text-8xl md:text-[12rem] uppercase tracking-tighter select-none pointer-events-none"
      style={{ color: '#00ffff', mixBlendMode: 'screen' }}
      initial={{ opacity: 0, x: 0 }}
      animate={{ x: [2, -2, 2], opacity: [0, 0.5, 0] }}
      transition={{ duration: 0.15, delay: 0.02 }}
      aria-hidden="true"
    >
      {isDudo ? 'DUDO!' : 'CALZA!'}
    </motion.span>
  </>
)}
```

Remove `filter: showGlitch ? 'url(#glitch)' : 'none'` from the main h1 style (line 149).

**4. DUDO-04: Reduce particles to 5 (lines 214-250)**

Change `[...Array(8)]` to `[...Array(5)]` and update angle calculation:

```tsx
{[...Array(5)].map((_, i) => {
  const angle = (i / 5) * Math.PI * 2;  // 5 instead of 8
  const distance = 120;  // Slightly reduced distance
  const endX = Math.cos(angle) * distance;
  const endY = Math.sin(angle) * distance;
  return (
    <motion.div
      key={i}
      className="absolute left-1/2 top-1/2 rounded-full"
      style={{
        width: 8,
        height: 8,
        marginLeft: -4,
        marginTop: -4,
        backgroundColor: mainColor,
        boxShadow: `0 0 8px ${mainColor}`,  // Static glow
      }}
      initial={{ opacity: 0, scale: 0, x: 0, y: 0 }}
      animate={{
        opacity: [0, 1, 0],
        scale: [0, 1.2, 0],  // Slightly smaller scale
        x: [0, endX],
        y: [0, endY]
      }}
      transition={{ duration: 0.4, delay: 0.2, ease: 'easeOut' }}
    />
  );
})}
```

The existing glitch lines (lines 82-108) already use transform/opacity - KEEP as-is.
The caller name section (lines 163-180) is fine - KEEP as-is.
The screenShake keyframes (lines 254-267) use transform - KEEP as-is.

Summary of what to KEEP unchanged:
- Container motion.div with scale/opacity/rotate (line 111-124)
- Shadow/depth layer (lines 126-136)
- Glitch lines (lines 82-108)
- Caller name with static textShadow (lines 163-180)
- Screen shake CSS (lines 254-267)
  </action>
  <verify>
Run `npm run build` - should complete without TypeScript errors.
Run `tsc --noEmit` - should pass type checking.
Grep for "backdropFilter.*blur.*0px" - should return NO matches (no animated blur).
Grep for "animate=.*textShadow" or "textShadow:.*\\[" - should return NO matches (no animated text-shadow).
Grep for "filter.*url.*#glitch" - should return NO matches (SVG filter removed).
Grep for "Array(8)" in DudoOverlay - should return NO matches (particles reduced).
  </verify>
  <done>
DudoOverlay.tsx refactored with:
- backdrop-filter is static (not in initial/animate props)
- Text glow uses pseudo-element with opacity animation only
- SVG glitch filter removed, replaced with CSS transform/opacity pseudo-elements
- Particles reduced from 8 to 5
- All animations use only transform (x, y, scale, rotate) and opacity
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GPU-optimized DudoOverlay with transform/opacity-only animations</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000
3. Create a multiplayer room and start a game with AI players
4. Make a Dudo call (or wait for AI to call Dudo)
5. Observe the overlay animation:
   - Backdrop blur should appear immediately (static blur) while container fades in
   - Text should have pulsing glow effect (glow layer opacity changes)
   - Brief RGB glitch should appear (red/cyan color shift)
   - Particles should burst outward smoothly (5 particles)
6. Repeat to see Calza animation (same structure, green color)
7. Animation should feel smooth and impactful, no visible frame drops

Optional: Open DevTools Performance panel, record during animation:
- Should see minimal "Paint" events
- Should NOT see long frames (>16ms) caused by filter operations
  </how-to-verify>
  <resume-signal>Type "approved" if animation looks good and runs smoothly, or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
After Task 1:
- [ ] `npm run build` passes
- [ ] No animated backdropFilter (grep returns empty)
- [ ] No animated textShadow (grep returns empty)
- [ ] No SVG glitch filter reference (grep returns empty)
- [ ] Particles reduced to 5 (grep confirms)

After Task 2:
- [ ] Visual verification confirms smooth animation
- [ ] Glow effect is visible and pulses
- [ ] Glitch effect triggers on impact
- [ ] Particles burst outward
</verification>

<success_criteria>
Phase 13 is complete when:
1. DudoOverlay animations run at 60fps (no dropped frames visible)
2. backdrop-filter is applied statically, not animated
3. Text glow pulses via pseudo-element opacity, not text-shadow animation
4. SVG glitch filter is gone, replaced with CSS-only RGB split
5. Particles reduced to 5, animating only transform/opacity
6. User confirms visual quality is maintained or improved
</success_criteria>

<output>
After completion, create `.planning/phases/13-dudooverlay-optimization/13-01-SUMMARY.md`
</output>
