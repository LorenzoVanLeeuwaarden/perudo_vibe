---
phase: 23-tutorial-foundation
plan: 03
type: execute
wave: 2
depends_on: ["23-01", "23-02"]
files_modified:
  - src/components/tutorial/TutorialScreen.tsx
  - src/components/tutorial/TutorialComplete.tsx
  - src/components/tutorial/index.ts
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can click How to Play and enter tutorial mode"
    - "Tutorial presents 3-player game with user and 2 AI opponents"
    - "Tutorial uses actual game components for authentic feel"
    - "User can exit tutorial and return to main menu"
    - "First-time visitors see gentle prompt suggesting tutorial"
  artifacts:
    - path: "src/components/tutorial/TutorialScreen.tsx"
      provides: "Tutorial screen container managing gameplay/complete states"
      exports: ["TutorialScreen"]
    - path: "src/components/tutorial/TutorialComplete.tsx"
      provides: "Tutorial completion celebration screen"
      exports: ["TutorialComplete"]
    - path: "src/app/page.tsx"
      provides: "Full tutorial integration with TutorialScreen"
      contains: "TutorialScreen"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/tutorial/TutorialScreen.tsx"
      via: "TutorialScreen import and render"
      pattern: "<TutorialScreen"
    - from: "src/components/tutorial/TutorialScreen.tsx"
      to: "src/components/tutorial/TutorialGameplay.tsx"
      via: "TutorialGameplay import and render"
      pattern: "<TutorialGameplay"
---

<objective>
Create TutorialScreen container and wire full tutorial flow into the application.

Purpose: Complete the tutorial integration - wrap TutorialGameplay in a screen manager (like GauntletModeScreen), add completion screen, first-time prompt, and wire everything into page.tsx. This makes the tutorial fully accessible and functional.

Output: Complete tutorial flow: Main Menu -> Tutorial -> (play through) -> Complete -> Main Menu
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-tutorial-foundation/23-CONTEXT.md
@.planning/phases/23-tutorial-foundation/23-RESEARCH.md
@.planning/phases/23-tutorial-foundation/23-01-SUMMARY.md
@.planning/phases/23-tutorial-foundation/23-02-SUMMARY.md
@src/components/gauntlet/GauntletModeScreen.tsx
@src/stores/tutorialStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TutorialScreen and TutorialComplete components</name>
  <files>src/components/tutorial/TutorialScreen.tsx, src/components/tutorial/TutorialComplete.tsx, src/components/tutorial/index.ts</files>
  <action>
Create TutorialScreen following GauntletModeScreen pattern:

**src/components/tutorial/TutorialComplete.tsx:**
```typescript
'use client';

import { motion } from 'framer-motion';
import { CheckCircle, ArrowRight } from 'lucide-react';
import { PlayerColor, PLAYER_COLORS } from '@/lib/types';

interface TutorialCompleteProps {
  playerColor: PlayerColor;
  onExit: () => void;
}

export function TutorialComplete({ playerColor, onExit }: TutorialCompleteProps) {
  const colorConfig = PLAYER_COLORS[playerColor];

  return (
    <div className="fixed inset-0 flex items-center justify-center p-4">
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ duration: 0.5, ease: 'easeOut' }}
        className="text-center max-w-md"
      >
        {/* Success icon */}
        <motion.div
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ delay: 0.2, type: 'spring', stiffness: 200 }}
          className="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center"
          style={{
            background: `linear-gradient(135deg, ${colorConfig.bg} 0%, ${colorConfig.shadow} 100%)`,
            boxShadow: `0 0 30px ${colorConfig.glow}`,
          }}
        >
          <CheckCircle className="w-10 h-10 text-white" />
        </motion.div>

        {/* Title */}
        <motion.h1
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="text-3xl font-bold text-white-soft mb-3"
        >
          Tutorial Complete!
        </motion.h1>

        {/* Message */}
        <motion.p
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.4 }}
          className="text-white-soft/70 mb-8"
        >
          You&apos;ve learned the basics of Perudo. Ready to play for real?
        </motion.p>

        {/* Action button */}
        <motion.button
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.5 }}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          onClick={onExit}
          className="retro-button retro-button-orange flex items-center gap-2 mx-auto"
        >
          Start Playing
          <ArrowRight className="w-5 h-5" />
        </motion.button>
      </motion.div>
    </div>
  );
}

export default TutorialComplete;
```

**src/components/tutorial/TutorialScreen.tsx:**
```typescript
'use client';

import { useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X } from 'lucide-react';
import { PlayerColor } from '@/lib/types';
import { ShaderBackground } from '@/components/ShaderBackground';
import { useTutorialStore } from '@/stores/tutorialStore';
import { TutorialGameplay } from './TutorialGameplay';
import { TutorialComplete } from './TutorialComplete';

interface TutorialScreenProps {
  playerColor: PlayerColor;
  onExit: () => void;
}

export function TutorialScreen({ playerColor, onExit }: TutorialScreenProps) {
  // Subscribe to tutorial store
  const screen = useTutorialStore((s) => s.screen);
  const startTutorial = useTutorialStore((s) => s.startTutorial);
  const completeTutorial = useTutorialStore((s) => s.completeTutorial);
  const exitTutorial = useTutorialStore((s) => s.exitTutorial);

  // Start tutorial on mount
  useEffect(() => {
    startTutorial();
  }, [startTutorial]);

  // Handle exit - clean up tutorial state
  const handleExit = () => {
    exitTutorial();
    onExit();
  };

  // Handle completion
  const handleComplete = () => {
    completeTutorial();
  };

  // Handle exit from complete screen
  const handleExitFromComplete = () => {
    exitTutorial();
    onExit();
  };

  return (
    <div className="relative w-full h-full">
      <ShaderBackground />

      {/* Exit button - always visible */}
      <motion.button
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.5 }}
        onClick={handleExit}
        className="fixed top-4 left-4 z-50 p-2 rounded-lg bg-purple-deep/80 hover:bg-purple-mid/80 border border-turquoise-dark/30 transition-colors"
        title="Exit tutorial"
      >
        <X className="w-5 h-5 text-white-soft/70" />
      </motion.button>

      {/* Screen flow with AnimatePresence */}
      <AnimatePresence mode="wait">
        {screen === 'gameplay' && (
          <motion.div
            key="gameplay"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="fixed inset-0"
          >
            <TutorialGameplay
              playerColor={playerColor}
              onComplete={handleComplete}
            />
          </motion.div>
        )}

        {screen === 'complete' && (
          <motion.div
            key="complete"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="fixed inset-0"
          >
            <TutorialComplete
              playerColor={playerColor}
              onExit={handleExitFromComplete}
            />
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default TutorialScreen;
```

**Update src/components/tutorial/index.ts:**
```typescript
export { TutorialGameplay } from './TutorialGameplay';
export { TutorialScreen } from './TutorialScreen';
export { TutorialComplete } from './TutorialComplete';
```
  </action>
  <verify>
`npx tsc --noEmit` passes
All components export correctly
TutorialScreen renders both gameplay and complete states
  </verify>
  <done>
TutorialScreen manages screen flow, TutorialComplete shows success state, both properly exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TutorialScreen into page.tsx and add first-time prompt</name>
  <files>src/app/page.tsx</files>
  <action>
Replace the placeholder tutorial rendering in page.tsx with full TutorialScreen:

1. Add import for TutorialScreen:
```typescript
import { TutorialScreen } from '@/components/tutorial';
```

2. Add state for first-time prompt:
```typescript
const [showTutorialPrompt, setShowTutorialPrompt] = useState(false);

// Check for first-time visitor
useEffect(() => {
  if (typeof window !== 'undefined') {
    const dismissed = localStorage.getItem('tutorial_prompt_dismissed');
    const completed = localStorage.getItem('tutorial_completed');
    if (!dismissed && !completed) {
      // Show prompt after a short delay (let user see the menu first)
      const timer = setTimeout(() => {
        setShowTutorialPrompt(true);
      }, 1500);
      return () => clearTimeout(timer);
    }
  }
}, []);

const handleDismissPrompt = () => {
  localStorage.setItem('tutorial_prompt_dismissed', 'true');
  setShowTutorialPrompt(false);
};

const handleAcceptPrompt = () => {
  setShowTutorialPrompt(false);
  setGameState('Tutorial');
};
```

3. Replace the placeholder tutorial block with TutorialScreen:
```typescript
{gameState === 'Tutorial' && (
  <div className="fixed inset-0 z-50">
    <TutorialScreen
      playerColor={playerColor}
      onExit={handleExitTutorial}
    />
  </div>
)}
```

4. Add first-time prompt modal (appears over ModeSelection):
```typescript
{/* First-time tutorial prompt */}
<AnimatePresence>
  {showTutorialPrompt && gameState === 'ModeSelection' && (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 z-50 flex items-center justify-center p-4"
      style={{ background: 'rgba(0, 0, 0, 0.7)', backdropFilter: 'blur(4px)' }}
    >
      <motion.div
        initial={{ opacity: 0, scale: 0.95, y: 20 }}
        animate={{ opacity: 1, scale: 1, y: 0 }}
        exit={{ opacity: 0, scale: 0.95, y: 20 }}
        className="retro-panel p-6 max-w-sm text-center"
        style={{
          borderColor: PLAYER_COLORS[playerColor].border,
          boxShadow: `0 0 20px ${PLAYER_COLORS[playerColor].glow}`,
        }}
      >
        <h2 className="text-xl font-bold text-white-soft mb-3">
          New to Perudo?
        </h2>
        <p className="text-white-soft/70 text-sm mb-6">
          Learn the rules with a quick tutorial. It only takes a few minutes!
        </p>
        <div className="flex gap-3 justify-center">
          <button
            onClick={handleDismissPrompt}
            className="px-4 py-2 text-sm text-white-soft/60 hover:text-white-soft transition-colors"
          >
            Skip
          </button>
          <button
            onClick={handleAcceptPrompt}
            className="retro-button retro-button-orange text-sm"
          >
            Show me how
          </button>
        </div>
      </motion.div>
    </motion.div>
  )}
</AnimatePresence>
```

5. Make sure handleExitTutorial resets tutorial state:
```typescript
const handleExitTutorial = useCallback(() => {
  useTutorialStore.getState().exitTutorial();
  setGameState('ModeSelection');
}, []);
```

The prompt appears once for new visitors. After dismissing or completing tutorial, it won't appear again.
  </action>
  <verify>
`npm run dev` starts
Navigate through full tutorial flow
First-time prompt appears for new visitors (clear localStorage to test)
Exit button works at any point
  </verify>
  <done>
Full tutorial flow works: Menu -> Tutorial -> Play -> Complete -> Menu
First-time prompt appears for new visitors
Exit available throughout
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete tutorial flow</name>
  <what-built>
Complete tutorial infrastructure:
- "How to Play" button on main menu
- Tutorial mode with scripted 3-player game
- All dice visible (god mode for learning)
- Predetermined dice rolls
- Tutorial completion screen
- First-time visitor prompt
- Exit available throughout
  </what-built>
  <how-to-verify>
1. Clear localStorage: `localStorage.clear()` in browser console
2. Refresh page - first-time prompt should appear
3. Click "Show me how" - enters tutorial
4. OR click "Skip" - returns to main menu, prompt won't reappear
5. From main menu, click "How to Play" - enters tutorial
6. Observe: 3-player game with visible dice (Alex and Sam opponents)
7. Make opening bid
8. Observe AI turns
9. Call Dudo when prompted
10. See reveal animation
11. Tutorial complete screen appears
12. Click "Start Playing" - returns to main menu
13. Click "How to Play" again - tutorial restarts (can replay)
14. Press X button at any time - exits to main menu

Expected:
- All dice visible for all players (god mode)
- Dice values are predetermined (same every time)
- Tutorial completion persists (check localStorage.tutorial_completed)
- Smooth animations throughout
  </how-to-verify>
  <resume-signal>
Type "approved" if flow works correctly
Or describe any issues found
  </resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npx tsc --noEmit` passes
3. `npm run lint` passes
4. Full tutorial flow navigable
5. First-time prompt works correctly
6. Exit button works at any point
7. Tutorial completion persists in localStorage
</verification>

<success_criteria>
- TutorialScreen manages gameplay/complete screen states
- TutorialComplete shows celebration and exit action
- page.tsx renders TutorialScreen when in Tutorial state
- First-time visitor prompt appears once and respects dismissal
- Exit button available throughout tutorial
- Complete flow: Menu -> Tutorial -> Play -> Complete -> Menu
- Human verification confirms authentic gameplay feel
</success_criteria>

<output>
After completion, create `.planning/phases/23-tutorial-foundation/23-03-SUMMARY.md`
</output>
