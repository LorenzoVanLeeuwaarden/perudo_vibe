---
phase: 02-mode-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types.ts
  - src/stores/uiStore.ts
  - src/components/ModeSelection.tsx
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees ModeSelection screen as the first thing when opening the app"
    - "User sees two equally prominent buttons: Play vs AI and Play with Friends"
    - "Selecting Play vs AI transitions to existing Lobby screen"
    - "Selecting Play with Friends shows placeholder/coming soon state"
    - "Returning user with saved preference auto-skips to preferred mode"
  artifacts:
    - path: "src/lib/types.ts"
      provides: "ModeSelection added to GameState type"
      contains: "ModeSelection"
    - path: "src/components/ModeSelection.tsx"
      provides: "Mode selection UI component"
      min_lines: 80
      exports: ["ModeSelection"]
    - path: "src/stores/uiStore.ts"
      provides: "preferredMode preference persistence"
      contains: "preferredMode"
    - path: "src/app/page.tsx"
      provides: "ModeSelection as initial GameState"
      contains: "ModeSelection"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/ModeSelection.tsx"
      via: "import and render in AnimatePresence"
      pattern: "import.*ModeSelection"
    - from: "src/components/ModeSelection.tsx"
      to: "src/stores/uiStore.ts"
      via: "useUIStore for preference"
      pattern: "useUIStore"
---

<objective>
Add mode selection screen as the new entry point for Perudo Vibe, allowing users to choose between single-player (vs AI) and multiplayer modes.

Purpose: This is the first step toward multiplayer - users need to explicitly choose their game mode before proceeding. The mode selection screen becomes the new landing page.

Output: ModeSelection component rendered as initial screen, with animated transitions to the selected game flow and preference persistence for returning users.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mode-selection/02-CONTEXT.md
@.planning/phases/02-mode-selection/02-RESEARCH.md

# Key source files
@src/lib/types.ts
@src/stores/uiStore.ts
@src/app/page.tsx
@src/components/VictoryScreen.tsx (for animation patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModeSelection component and extend GameState</name>
  <files>
    src/lib/types.ts
    src/components/ModeSelection.tsx
  </files>
  <action>
1. In src/lib/types.ts, add 'ModeSelection' to the GameState union type:
   ```typescript
   export type GameState = 'ModeSelection' | 'Lobby' | 'Rolling' | 'Bidding' | 'Reveal' | 'Victory' | 'Defeat';
   ```

2. Create src/components/ModeSelection.tsx with:
   - Props: onSelectAI: () => void, onSelectMultiplayer: () => void, playerColor: PlayerColor
   - Two large motion.button elements stacked vertically (flex-col, gap-6)
   - Bot icon + "Play vs AI" label + "Challenge computer opponents" subtitle
   - Users icon + "Play with Friends" label + "Create or join a room" subtitle
   - Use PLAYER_COLORS[playerColor] for button styling (same pattern as VictoryScreen)
   - Animated entry: initial={{ opacity: 0, y: 50 }}, animate={{ opacity: 1, y: 0 }} with staggered delay
   - whileHover={{ scale: 1.05, y: -4 }}, whileTap={{ scale: 0.98, y: 0 }}
   - Selection animation: track selectedMode state, when set:
     - Selected button: animate={{ scale: 1.1, filter: 'brightness(1.2)' }}
     - Other button: animate={{ opacity: 0, scale: 0.9 }}
     - After 500ms delay, call the onSelect callback
   - Use CasinoLogo or game title at top (import from existing)
   - retro-panel class on buttons for consistent styling
   - Responsive: w-full max-w-md mx-auto for mobile

Animation flow:
- On mount: Title fades in, then buttons stagger in (0.2s delay between)
- On selection: Selected button glows/scales, other fades, 500ms later transition fires

Icons: import { Bot, Users } from 'lucide-react'
  </action>
  <verify>
    - TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
    - ModeSelection.tsx exists and exports ModeSelection component
  </verify>
  <done>
    - GameState type includes 'ModeSelection'
    - ModeSelection component renders two animated buttons with Bot and Users icons
    - Selection triggers animation before callback
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ModeSelection into page.tsx and add preference persistence</name>
  <files>
    src/stores/uiStore.ts
    src/app/page.tsx
  </files>
  <action>
1. In src/stores/uiStore.ts:
   - Add to UIStore interface:
     ```typescript
     preferredMode: 'ai' | 'multiplayer' | null;
     setPreferredMode: (mode: 'ai' | 'multiplayer') => void;
     ```
   - Add initial state: preferredMode: null
   - Add action: setPreferredMode: (mode) => set({ preferredMode: mode })
   - Add preferredMode to partialize object for persistence

2. In src/app/page.tsx:
   - Import ModeSelection from '@/components/ModeSelection'
   - Import useUIStore from '@/stores/uiStore' (if not already)
   - Change initial gameState from 'Lobby' to 'ModeSelection':
     ```typescript
     const [gameState, setGameState] = useState<GameState>('ModeSelection');
     ```
   - Get preferredMode and setPreferredMode from useUIStore
   - Add useEffect for auto-skip on hydration:
     ```typescript
     useEffect(() => {
       // Only auto-skip after hydration, not on initial server render
       if (preferredMode === 'ai' && gameState === 'ModeSelection') {
         setGameState('Lobby');
       }
       // Don't auto-skip multiplayer yet - that flow doesn't exist
     }, [preferredMode]); // Run once after hydration
     ```
   - Add handlers:
     ```typescript
     const handleSelectAI = useCallback(() => {
       setPreferredMode('ai');
       setGameState('Lobby');
     }, [setPreferredMode]);

     const handleSelectMultiplayer = useCallback(() => {
       setPreferredMode('multiplayer');
       // For now, show alert - multiplayer flow built in Phase 3
       alert('Multiplayer coming soon! Building room creation next.');
       // Reset selection state in ModeSelection via re-render
     }, [setPreferredMode]);
     ```
   - Add ModeSelection to AnimatePresence (before Lobby case):
     ```typescript
     {gameState === 'ModeSelection' && (
       <motion.div
         key="mode-selection"
         initial={{ opacity: 0, scale: 0.9 }}
         animate={{ opacity: 1, scale: 1 }}
         exit={{ opacity: 0, scale: 0.9 }}
         className="..."
       >
         <ModeSelection
           onSelectAI={handleSelectAI}
           onSelectMultiplayer={handleSelectMultiplayer}
           playerColor={playerColor}
         />
       </motion.div>
     )}
     ```
   - Ensure AnimatePresence has mode="wait" (should already)

Note: The multiplayer button triggers an alert for now - actual room creation flow is Phase 3.
  </action>
  <verify>
    - TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
    - Dev server runs: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npm run dev` (check no errors in terminal)
    - Open http://localhost:3000 and see ModeSelection screen (not Lobby)
  </verify>
  <done>
    - uiStore has preferredMode state with persistence
    - page.tsx starts at 'ModeSelection' state
    - Clicking "Play vs AI" transitions to Lobby
    - Clicking "Play with Friends" shows placeholder message
    - Refreshing page after selecting AI auto-skips to Lobby
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Mode selection screen with two animated buttons and preference persistence</what-built>
  <how-to-verify>
1. Open http://localhost:3000 in browser
2. Verify: You see ModeSelection screen with:
   - Game title/logo at top
   - Two large buttons: "Play vs AI" (robot icon) and "Play with Friends" (people icon)
   - Buttons have hover animations (scale up, lift)
   - Dia de los Muertos theme matches rest of game

3. Click "Play vs AI":
   - Selected button should glow/scale up briefly
   - Other button should fade out
   - After short delay, Lobby screen appears (existing opponent selection)

4. Click browser refresh:
   - Should auto-skip to Lobby (preference remembered)

5. Clear localStorage (DevTools > Application > Clear site data) and refresh:
   - Should see ModeSelection again

6. Click "Play with Friends":
   - Should see alert "Multiplayer coming soon!"
   - Should stay on ModeSelection screen

7. Test mobile: Use DevTools responsive mode (375px width)
   - Buttons should stack vertically and fit on screen
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors
2. App loads with ModeSelection as first screen
3. AI mode flows to existing game
4. Preference persists across refresh
5. Mobile responsive layout works
</verification>

<success_criteria>
- MODE-01 requirement satisfied: User can choose between single-player (vs AI) and multiplayer modes
- Phase 2 Success Criteria 1: User sees clear choice between "Play vs AI" and "Play with Friends" on landing page
- Phase 2 Success Criteria 2: Selecting "Play vs AI" starts single-player game with existing flow
- Phase 2 Success Criteria 3: Selecting "Play with Friends" initiates multiplayer room creation flow (placeholder for now)
</success_criteria>

<output>
After completion, create `.planning/phases/02-mode-selection/02-01-SUMMARY.md`
</output>
