---
phase: 08-disconnect-reconnection
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/PlayerRow.tsx
  - src/components/GameBoard.tsx
  - src/app/room/[code]/page.tsx
  - src/shared/messages.ts
autonomous: false

must_haves:
  truths:
    - "Disconnected player's card appears grayed out after 5-10 seconds"
    - "Reconnecting player sees 'Welcome back!' toast"
    - "Other players see player card un-gray when player reconnects"
    - "Disconnect indicator (wifi-off icon) shows for disconnected players"
  artifacts:
    - path: "src/components/PlayerRow.tsx"
      provides: "Grayed-out visual style for disconnected players"
      contains: "disconnectedAt"
    - path: "src/components/GameBoard.tsx"
      provides: "Player list with disconnect visuals during game"
      contains: "isDisconnectedVisually"
    - path: "src/app/room/[code]/page.tsx"
      provides: "Welcome back toast for reconnecting player"
      contains: "Welcome back"
  key_links:
    - from: "src/components/PlayerRow.tsx"
      to: "player.disconnectedAt"
      via: "conditional gray styling"
      pattern: "disconnectedAt.*Date\\.now"
    - from: "src/app/room/[code]/page.tsx"
      to: "PLAYER_RECONNECTED handler"
      via: "checks if message is for self"
      pattern: "playerId.*===.*myPlayerId"
---

<objective>
Implement client-side disconnect visuals and reconnection feedback

Purpose: Players should see a visual indicator when another player disconnects (grayed out card), and reconnecting players should receive welcoming feedback. The disconnect visual has a 5-second delay to avoid flicker on brief network blips.

Output: Disconnected players appear grayed out, reconnecting players see "Welcome back!" toast, other players see the un-graying transition.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-disconnect-reconnection/08-CONTEXT.md
@.planning/phases/08-disconnect-reconnection/08-RESEARCH.md
@.planning/phases/08-disconnect-reconnection/08-01-SUMMARY.md
@src/components/PlayerRow.tsx
@src/components/GameBoard.tsx
@src/app/room/[code]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grayed-out disconnect visual to PlayerRow</name>
  <files>src/components/PlayerRow.tsx</files>
  <action>
Update PlayerRow component to show a grayed-out appearance for disconnected players.

**Props update:**
Add optional `showDisconnectedVisual?: boolean` prop to PlayerRowProps. The parent component will calculate this based on the 5-second delay logic.

**Visual changes when showDisconnectedVisual is true:**
1. Reduce opacity of the entire row to 50% (`opacity-50`)
2. Add grayscale filter (`grayscale`)
3. Keep the existing WifiOff icon (already shows when !isConnected)

**Styling approach:**
```tsx
<div
  className={`flex items-center gap-3 p-3 rounded-lg border transition-all duration-300 ${
    showDisconnectedVisual ? 'opacity-50 grayscale' : ''
  } ${
    isMe
      ? 'bg-purple-mid/30 border-purple-glow'
      : 'bg-purple-deep/30 border-purple-mid'
  }`}
>
```

The `transition-all duration-300` ensures smooth fade when player reconnects.

**Note:** The WifiOff icon already exists in PlayerRow for !isConnected. Keep this logic unchanged - it will show immediately when server reports disconnect, while the grayed-out visual has the 5-second delay.
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Visually confirm in browser that a disconnected player's card would show reduced opacity and grayscale.
  </verify>
  <done>PlayerRow shows grayed-out visual when showDisconnectedVisual prop is true. Smooth transition when state changes.</done>
</task>

<task type="auto">
  <name>Task 2: Implement 5-second delay logic for disconnect visual in GameBoard</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Calculate whether to show the disconnect visual based on the 5-second delay rule.

**Add helper function:**
```typescript
function shouldShowDisconnectedVisual(player: ServerPlayer, currentTime: number): boolean {
  // Show disconnect visual if:
  // 1. Player is not connected
  // 2. disconnectedAt is set
  // 3. At least 5 seconds have passed since disconnect
  if (player.isConnected) return false;
  if (!player.disconnectedAt) return false;
  return (currentTime - player.disconnectedAt) >= 5000;
}
```

**Add state for current time:**
```typescript
const [currentTime, setCurrentTime] = useState(Date.now());

// Update every second to recalculate disconnect visuals
useEffect(() => {
  const interval = setInterval(() => {
    setCurrentTime(Date.now());
  }, 1000);
  return () => clearInterval(interval);
}, []);
```

**Usage in player list rendering:**
When rendering player cards, calculate `showDisconnectedVisual` for each player:
```tsx
{players.map(player => (
  <PlayerRow
    key={player.id}
    player={player}
    isMe={player.id === myPlayerId}
    showKick={false}
    onKick={() => {}}
    showDisconnectedVisual={shouldShowDisconnectedVisual(player, currentTime)}
  />
))}
```

**Note:** GameBoard renders player info during the game. The RoomLobby also shows PlayerRow but can use a simpler approach (immediate visual) since lobby disconnects are less disruptive.
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Review that disconnect visual only shows after 5 seconds have passed.
  </verify>
  <done>GameBoard calculates disconnect visual timing. Players appear grayed out only after 5-second delay, avoiding flicker on brief network blips.</done>
</task>

<task type="auto">
  <name>Task 3: Add "Welcome back!" toast for reconnecting player and update state handling</name>
  <files>src/app/room/[code]/page.tsx, src/shared/messages.ts</files>
  <action>
**In page.tsx - Update PLAYER_RECONNECTED handler:**

The existing handler shows `${message.playerName} reconnected` toast for everyone. Update to show "Welcome back! You're back in the game" for the reconnecting player themselves.

```typescript
case 'PLAYER_RECONNECTED':
  setJoinState(prev => {
    if (prev.status === 'joined') {
      // Check if this reconnection message is for ourselves
      const isMe = message.playerId === prev.playerId;

      // Schedule toast after state update
      queueMicrotask(() => {
        if (isMe) {
          toast.success("Welcome back! You're back in the game");
        } else {
          toast.success(`${message.playerName} reconnected`);
        }
      });

      return {
        ...prev,
        roomState: {
          ...prev.roomState,
          players: prev.roomState.players.map(p =>
            p.id === message.playerId
              ? { ...p, isConnected: true, disconnectedAt: null }
              : p
          ),
        },
      };
    }
    return prev;
  });
  break;
```

**In page.tsx - Update PLAYER_LEFT handler:**

When handling 'disconnected' reason, also set disconnectedAt:
```typescript
if (message.reason === 'disconnected') {
  return {
    ...prev,
    roomState: {
      ...prev.roomState,
      players: prev.roomState.players.map(p =>
        p.id === message.playerId
          ? { ...p, isConnected: false, disconnectedAt: Date.now() }
          : p
      ),
    },
  };
}
```

**In page.tsx - Update ROOM_STATE handler:**

Ensure disconnectedAt is preserved or initialized when receiving full room state. The server now sends disconnectedAt in player objects.

**In messages.ts (if needed):**

Verify that PLAYER_RECONNECTED message schema doesn't need changes - it already has playerId and playerName which is sufficient for the client-side logic.
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Review that reconnecting player sees "Welcome back!" while others see "{name} reconnected".
Review that disconnectedAt is set on PLAYER_LEFT and cleared on PLAYER_RECONNECTED.
  </verify>
  <done>
Reconnecting player sees "Welcome back! You're back in the game" toast.
Other players see "{name} reconnected" toast.
disconnectedAt is properly tracked in client state.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete disconnect/reconnection flow:
1. Server tracks disconnectedAt and schedules 60-second elimination
2. AI plays for disconnected player on their turn
3. Disconnected player card shows grayed out after 5 seconds
4. Reconnecting player sees "Welcome back!" toast
5. Other players see player card transition from gray to normal
  </what-built>
  <how-to-verify>
**Test setup:** Open two browser windows to the same room.

**Test 1: Disconnect visual (5-second delay)**
1. Start a game with 2 players
2. In one browser, open DevTools > Network tab
3. Set throttling to "Offline" to simulate disconnect
4. Wait 5 seconds
5. Verify: In the other browser, the disconnected player's card should be grayed out with wifi-off icon

**Test 2: Reconnection flow**
1. Set throttling back to "Online"
2. Verify: The disconnected player sees "Welcome back!" toast
3. Verify: The other player sees "{name} reconnected" toast
4. Verify: The grayed-out visual disappears immediately

**Test 3: AI takeover on disconnect**
1. Make sure it's Player 1's turn
2. Disconnect Player 1 (offline mode)
3. Wait for turn timer to expire
4. Verify: AI makes a move for disconnected player (bot badge should appear)
5. Reconnect Player 1
6. Verify: Player 1 can continue playing normally

**Test 4: Page refresh reconnection**
1. During an active game, refresh one player's page
2. Verify: Player rejoins with their state intact (dice, current game state)
3. Verify: Other player sees brief disconnect then reconnect messages

**Expected behavior:**
- Gray visual has ~5 second delay (not immediate on disconnect)
- Reconnection is seamless with appropriate toasts
- AI plays conservatively for disconnected players
- No game stalling or corruption
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Dev server runs: `npm run dev` without errors
3. Manual testing: Disconnect/reconnection flow works as specified
4. Visual check: Grayed-out styling looks appropriate (not jarring)
5. Toast messages: Correct message for self vs others
</verification>

<success_criteria>
- Disconnected players show grayed-out card after 5-second delay
- WifiOff icon shows immediately on disconnect (existing behavior)
- Reconnecting player sees "Welcome back! You're back in the game" toast
- Other players see "{name} reconnected" toast
- Player card transitions smoothly from gray to normal on reconnection
- AI plays for disconnected player on their turn (bot badge visible)
- Page refresh allows player to rejoin with state intact
</success_criteria>

<output>
After completion, create `.planning/phases/08-disconnect-reconnection/08-02-SUMMARY.md`
</output>
