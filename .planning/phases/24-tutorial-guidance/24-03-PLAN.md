---
phase: 24-tutorial-guidance
plan: 03
type: execute
wave: 2
depends_on: [24-01, 24-02]
files_modified:
  - src/components/tutorial/TutorialGameplay.tsx
autonomous: false

must_haves:
  truths:
    - "User's move choices are constrained to intended action at each step"
    - "Disabled options show tooltip explaining why unavailable"
    - "Tooltips appear with explanations at teaching moments"
    - "Visual cues (highlights, arrows) draw attention to interactive elements"
    - "Dice relevant to current explanation pulse/glow to focus attention"
  artifacts:
    - path: "src/components/tutorial/TutorialGameplay.tsx"
      provides: "Integrated guidance system with tooltips and constraints"
      contains: "TutorialTooltip"
  key_links:
    - from: "src/components/tutorial/TutorialGameplay.tsx"
      to: "src/components/tutorial/TutorialTooltip.tsx"
      via: "tooltip rendering"
      pattern: "<TutorialTooltip"
    - from: "src/components/tutorial/TutorialGameplay.tsx"
      to: "src/lib/tutorial/script.ts"
      via: "scriptStep.tooltip"
      pattern: "scriptStep\\.tooltip"
    - from: "src/components/tutorial/TutorialGameplay.tsx"
      to: "SortedDiceDisplay"
      via: "highlightValue prop"
      pattern: "highlightValue="
---

<objective>
Integrate tooltip components and action constraints into TutorialGameplay for the complete guidance experience.

Purpose: Wire everything together so the tutorial shows tooltips, highlights dice and buttons, and constrains user actions to the intended tutorial flow.
Output: TutorialGameplay renders tooltips from script, constrains BidUI actions, highlights relevant dice and buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-tutorial-guidance/24-CONTEXT.md
@.planning/phases/24-tutorial-guidance/24-RESEARCH.md
@.planning/phases/24-tutorial-guidance/24-01-SUMMARY.md
@.planning/phases/24-tutorial-guidance/24-02-SUMMARY.md
@src/components/tutorial/TutorialGameplay.tsx
@src/components/tutorial/TutorialTooltip.tsx
@src/components/tutorial/TutorialOverlay.tsx
@src/components/tutorial/DisabledButtonWrapper.tsx
@src/lib/tutorial/script.ts
@src/lib/tutorial/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tooltip state and rendering to TutorialGameplay</name>
  <files>src/components/tutorial/TutorialGameplay.tsx</files>
  <action>
Import tooltip components:
```typescript
import { TutorialTooltip, TutorialOverlay, DisabledButtonWrapper } from '@/components/tutorial';
```

Add tooltip state:
```typescript
const [showTooltip, setShowTooltip] = useState(false);
const [tooltipDismissed, setTooltipDismissed] = useState(false);
```

Reset tooltip state when step changes:
- In the useEffect that handles step changes, reset tooltipDismissed to false
- Show tooltip after a brief delay (300ms) if scriptStep.tooltip exists and not dismissed

Handle tooltip dismissal:
```typescript
const handleTooltipDismiss = useCallback(() => {
  setShowTooltip(false);
  setTooltipDismissed(true);

  // For click-to-continue tooltips, advance step after dismissal
  // BUT only if the step's requiredAction is 'wait'
  // For 'bid' or 'dudo' actions, user must still perform the action
  if (scriptStep?.tooltip?.dismissMode === 'click' && scriptStep.requiredAction.type === 'wait') {
    advanceStep();
  }
}, [scriptStep, advanceStep]);
```

Handle auto-advance tooltips:
- In useEffect, if tooltip.dismissMode === 'auto', set timer to dismiss and advance
- Clear timer on cleanup to prevent race conditions (per RESEARCH.md pitfall 6)

Render tooltip and overlay in JSX:
```jsx
<AnimatePresence>
  {showTooltip && scriptStep?.tooltip && (
    <>
      <TutorialOverlay onDismiss={handleTooltipDismiss} />
      <TutorialTooltip
        content={scriptStep.tooltip.content}
        position={scriptStep.tooltip.position}
        playerColor={playerColor}
        style={getTooltipPosition(scriptStep.tooltip.targetElement)}
      />
    </>
  )}
</AnimatePresence>
```

Create getTooltipPosition helper that returns CSS positioning based on targetElement:
- 'player-dice': bottom center of screen, pointing up
- 'bid-button': above BidUI area
- 'dudo-button': above BidUI area
- 'bid-display': below the current bid display
- 'opponent-dice': below opponent dice section
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Tooltips render at correct positions with click-to-dismiss functionality</done>
</task>

<task type="auto">
  <name>Task 2: Implement dice highlighting and button pulsing</name>
  <files>src/components/tutorial/TutorialGameplay.tsx</files>
  <action>
Implement dice highlighting using existing SortedDiceDisplay highlightValue prop:

For player dice, pass highlightValue when scriptStep.highlightDice targets include 'player':
```typescript
const playerHighlightValue = useMemo(() => {
  if (!scriptStep?.highlightDice) return null;
  if (!scriptStep.highlightDice.targets.includes('player')) return null;

  if (scriptStep.highlightDice.type === 'matching-value') {
    return scriptStep.highlightDice.value || null;
  }
  if (scriptStep.highlightDice.type === 'jokers') {
    return 1; // Highlight jokers
  }
  return null;
}, [scriptStep]);

<SortedDiceDisplay
  dice={playerHand}
  color={playerColor}
  size="lg"
  animateSort={true}
  highlightValue={playerHighlightValue}
/>
```

For opponent dice, calculate highlight for each opponent:
```typescript
const getOpponentHighlightValue = (opponentIndex: number): number | null => {
  if (!scriptStep?.highlightDice) return null;
  if (!scriptStep.highlightDice.targets.includes(opponentIndex as 0 | 1)) return null;

  if (scriptStep.highlightDice.type === 'matching-value') {
    return scriptStep.highlightDice.value || null;
  }
  if (scriptStep.highlightDice.type === 'jokers') {
    return 1;
  }
  return null;
};
```

Then in opponent rendering, instead of mapping directly to Dice components, use SortedDiceDisplay (or add highlighting to individual Dice components):
- Option A: Replace opponent dice rendering with SortedDiceDisplay for consistency
- Option B: Pass highlighted prop to individual Dice components

Choose Option A for consistency. Update opponent dice rendering to use SortedDiceDisplay with highlightValue.

Implement button pulsing animation for BidUI buttons:
- Define pulseAnimation constant for Framer Motion:
```typescript
const pulseAnimation = {
  filter: [
    `drop-shadow(0 0 10px ${PLAYER_COLORS[playerColor].glow})`,
    `drop-shadow(0 0 25px ${PLAYER_COLORS[playerColor].glow})`,
    `drop-shadow(0 0 10px ${PLAYER_COLORS[playerColor].glow})`,
  ],
};
```
- Pass this to BidUI buttons (this requires modifying how BidUI is rendered in tutorial mode - see Task 3)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Dice matching the current explanation are highlighted with glow effect</done>
</task>

<task type="auto">
  <name>Task 3: Constrain BidUI actions and add disabled tooltips</name>
  <files>src/components/tutorial/TutorialGameplay.tsx</files>
  <action>
Replace the standard BidUI with a tutorial-specific constrained version.

Per CONTEXT.md: "Bid UI: both quantity and face value locked - user just clicks 'Bid' to confirm"

Create custom tutorial BidUI section (don't modify BidUI.tsx - keep it generic):

When scriptStep.requiredAction.type === 'bid':
1. Show the bid display with LOCKED values from scriptStep.requiredAction.bid
2. Show BID button with pulsing glow (highlightButton === 'bid')
3. If currentBid exists, show DUDO button as DISABLED with DisabledButtonWrapper
4. Clicking BID calls handleBid with the required bid (not user-selected values)

When scriptStep.requiredAction.type === 'dudo':
1. Show the current bid display (locked)
2. Show BID button as DISABLED with DisabledButtonWrapper (tooltip: "The bid is too high to raise! Call their bluff.")
3. Show DUDO button with pulsing glow (highlightButton === 'dudo')

Implementation approach - render custom tutorial bid panel instead of BidUI:
```jsx
{gameState === 'Bidding' && isMyTurn && (
  <TutorialBidPanel
    scriptStep={scriptStep}
    currentBid={currentBid}
    playerColor={playerColor}
    onBid={handleBid}
    onDudo={handleDudo}
    useSimplifiedAnimations={useSimplifiedAnimations}
  />
)}
```

Create TutorialBidPanel as a local component (inside TutorialGameplay.tsx or as a separate file):
- Shows required bid values as static display (count x value)
- Renders Dice preview of the bid
- BID button: enabled + pulsing if requiredAction is 'bid', disabled + tooltip otherwise
- DUDO button: enabled + pulsing if requiredAction is 'dudo', disabled + tooltip otherwise

Disabled button tooltips per CONTEXT.md:
- BID disabled: "First, let's learn basic bidding" (for wait steps) or "The bid is too high to raise! Call their bluff." (for dudo steps)
- DUDO disabled: "Not yet! Watch what happens first." (for wait steps) or "Let's make a bid first." (for bid steps with no currentBid)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>User can only perform the intended action at each step; disabled buttons show explanatory tooltips</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete tutorial guidance system:
- Tooltips appear at each step with explanations
- Dice highlight when relevant to the explanation
- Buttons pulse when they should be clicked
- Disabled buttons show tooltips explaining why
- Actions are constrained to the intended tutorial flow
  </what-built>
  <how-to-verify>
1. Run `npm run dev`
2. Click "How to Play" on main menu
3. Observe Step 0 (roll-dice):
   - Tooltip appears: "Welcome! These are your dice..."
   - Click anywhere to dismiss
4. Observe Step 1 (first-bid):
   - Your 3s should be highlighted
   - BID button should pulse
   - DUDO button should be disabled with tooltip on hover
   - Click BID to proceed
5. Observe Step 2-3 (alex-bids, sam-bids):
   - "Alex is thinking..." tooltip auto-advances
   - Alex's 4s highlight when he bids
   - "Sam is thinking..." tooltip auto-advances
6. Observe Step 4 (player-dudo):
   - All 5s across all hands should be highlighted
   - DUDO button should pulse
   - BID button should be disabled with tooltip
   - Click DUDO
7. Observe Step 5 (reveal):
   - Reveal animation plays
   - Tutorial completes

Verify:
- All tooltips readable and positioned correctly
- Dice highlighting draws attention to relevant dice
- Button pulsing is noticeable but not obnoxious
- Disabled button tooltips appear on hover
- Cannot perform wrong actions (clicking disabled buttons does nothing)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Build succeeds: `npm run build` completes without errors
3. Tutorial flow works: User can complete tutorial with guidance
4. Constraints enforced: User cannot perform wrong actions
5. Visual cues clear: Dice highlight, buttons pulse, tooltips positioned correctly
</verification>

<success_criteria>
- Tooltips appear at each teaching moment with friendly explanations
- Dice relevant to current explanation are highlighted
- Correct action button pulses with player-color glow
- Disabled buttons show accessible tooltip on hover/focus
- User cannot deviate from intended tutorial flow
- Tutorial completes successfully with all guidance elements working
</success_criteria>

<output>
After completion, create `.planning/phases/24-tutorial-guidance/24-03-SUMMARY.md`
</output>
