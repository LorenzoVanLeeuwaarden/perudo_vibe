---
phase: 21-leaderboard-system
plan: 05
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - src/components/gauntlet/LeaderboardScreen.tsx
  - src/components/gauntlet/SubmitScoreModal.tsx
  - src/components/gauntlet/GameOverScreen.tsx
  - src/hooks/useCountdownToMidnight.ts
  - src/stores/gauntletStore.ts
autonomous: false

must_haves:
  truths:
    - "Player can submit score with nickname after game over"
    - "Player can view leaderboard showing top 100 with nicknames"
    - "Player sees 'Near you' section with 3 above and 3 below their rank"
    - "Player sees countdown timer to midnight UTC reset"
    - "Player's personal best is displayed on game over screen"
    - "Leaderboard is accessible from game over screen"
  artifacts:
    - path: "src/components/gauntlet/LeaderboardScreen.tsx"
      provides: "Leaderboard view with top 100 and near you section"
      min_lines: 80
    - path: "src/components/gauntlet/SubmitScoreModal.tsx"
      provides: "Modal for nickname input and score submission"
      min_lines: 50
    - path: "src/components/gauntlet/GameOverScreen.tsx"
      provides: "Updated game over with submit/leaderboard buttons"
      contains: "SubmitScoreModal"
    - path: "src/hooks/useCountdownToMidnight.ts"
      provides: "Hook for countdown timer to midnight UTC"
      exports: ["useCountdownToMidnight"]
    - path: "src/stores/gauntletStore.ts"
      provides: "Store with leaderboard screen state"
      contains: "leaderboard"
  key_links:
    - from: "src/components/gauntlet/GameOverScreen.tsx"
      to: "src/components/gauntlet/SubmitScoreModal.tsx"
      via: "import and render"
      pattern: "import.*SubmitScoreModal"
    - from: "src/components/gauntlet/LeaderboardScreen.tsx"
      to: "src/lib/leaderboard-api.ts"
      via: "fetch leaderboard data"
      pattern: "import.*leaderboard-api"
    - from: "src/components/gauntlet/LeaderboardScreen.tsx"
      to: "src/hooks/useCountdownToMidnight.ts"
      via: "countdown timer"
      pattern: "useCountdownToMidnight"
---

<objective>
Implement leaderboard UI components with submission flow and countdown timer

Purpose: Complete user-facing leaderboard experience (LEAD-02, LEAD-03, LEAD-06, LEAD-07 UI)
Output: LeaderboardScreen, SubmitScoreModal, updated GameOverScreen, countdown hook
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-leaderboard-system/21-RESEARCH.md
@.planning/phases/21-leaderboard-system/21-02-SUMMARY.md
@.planning/phases/21-leaderboard-system/21-03-SUMMARY.md

@src/components/gauntlet/GameOverScreen.tsx
@src/stores/gauntletStore.ts
@src/lib/leaderboard-api.ts
@src/lib/personal-best.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create countdown hook and submit modal</name>
  <files>src/hooks/useCountdownToMidnight.ts, src/components/gauntlet/SubmitScoreModal.tsx</files>
  <action>
**Create countdown hook (src/hooks/useCountdownToMidnight.ts):**
```typescript
import { useState, useEffect } from 'react';

export function useCountdownToMidnight(): string {
  const [timeLeft, setTimeLeft] = useState<string>('');

  useEffect(() => {
    function updateCountdown() {
      const now = new Date();
      const midnight = new Date(Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate() + 1,
        0, 0, 0, 0
      ));

      const diff = midnight.getTime() - now.getTime();
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      setTimeLeft(`${hours}h ${minutes}m ${seconds}s`);
    }

    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
    return () => clearInterval(interval);
  }, []);

  return timeLeft;
}
```

**Create SubmitScoreModal (src/components/gauntlet/SubmitScoreModal.tsx):**
- Props: isOpen, onClose, score, onSubmitSuccess
- State: nickname input, isSubmitting, error
- Validation: 2-30 chars, alphanumeric+spaces only
- On submit: call submitScore from leaderboard-api, show loading, handle errors
- On success: call onSubmitSuccess, close modal
- Style: Dark modal overlay, red/dark theme matching GameOverScreen
- Use framer-motion for enter/exit animations
  </action>
  <verify>`npx tsc --noEmit src/hooks/useCountdownToMidnight.ts src/components/gauntlet/SubmitScoreModal.tsx`</verify>
  <done>Countdown hook and submit modal with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create LeaderboardScreen component</name>
  <files>src/components/gauntlet/LeaderboardScreen.tsx</files>
  <action>
Create full leaderboard view component:

**Structure:**
- Header with "Daily Leaderboard" title and countdown timer
- Top 100 list (scrollable, showing rank, nickname, score)
- "Near You" section (if player has submitted - show 3 above, player, 3 below)
- Personal best display
- Back button to return to game over screen

**Data fetching:**
- useEffect to fetch leaderboard on mount
- Fetch nearby scores if player submitted this session
- Loading state while fetching
- Error state with retry button

**Styling:**
- Dark theme consistent with Gauntlet aesthetic
- Gold/yellow highlight for top 3 ranks
- Player's own entry highlighted in the list
- Responsive scrolling for long list

**Props:**
- playerScore: number (current run's score)
- onBack: () => void

**State:**
- items: LeaderboardEntry[]
- nearbyScores: { above, below } | null
- playerRank: number | null
- isLoading: boolean
- error: string | null
  </action>
  <verify>`npx tsc --noEmit src/components/gauntlet/LeaderboardScreen.tsx`</verify>
  <done>LeaderboardScreen with top 100, near you section, and countdown timer</done>
</task>

<task type="auto">
  <name>Task 3: Update GameOverScreen and store</name>
  <files>src/components/gauntlet/GameOverScreen.tsx, src/stores/gauntletStore.ts</files>
  <action>
**Update gauntletStore.ts:**
Add screen state for leaderboard:
```typescript
type ScreenState = 'rules' | 'fightCard' | 'gameplay' | 'victory' | 'gameOver' | 'leaderboard';

// Add to interface:
hasSubmittedScore: boolean;
showLeaderboard: () => void;
hideLeaderboard: () => void;
setScoreSubmitted: () => void;
```

**Update GameOverScreen.tsx:**
1. Add state: showSubmitModal, hasSubmittedThisSession
2. Add personal best display below streak count (from store)
3. Add "Submit Score" button (disabled after submission)
4. Add "View Leaderboard" button
5. Import and render SubmitScoreModal
6. On submit success: set hasSubmittedThisSession, update personal best nickname if needed

**Button layout:**
- Primary: "Enter the Gauntlet Again" (existing)
- Secondary row: "Submit Score" | "View Leaderboard"
- Tertiary: "Return to Menu" (existing)

**Submit Score button states:**
- Default: "Submit Score"
- After submission: "Score Submitted" (disabled, checkmark icon)
- On error: Show error toast, keep button enabled

**Conditional rendering:**
- If store.screen === 'leaderboard': render LeaderboardScreen instead of GameOverScreen content
  </action>
  <verify>`npm run lint -- --quiet src/components/gauntlet/GameOverScreen.tsx src/stores/gauntletStore.ts`</verify>
  <done>GameOverScreen has submit/leaderboard buttons, store tracks submission state</done>
</task>

</tasks>

<verification>
1. All components compile: `npx tsc --noEmit`
2. No lint errors: `npm run lint -- --quiet`
3. Store exports new actions: `grep -E "showLeaderboard|hasSubmittedScore" src/stores/gauntletStore.ts`
4. GameOverScreen imports modal: `grep "SubmitScoreModal" src/components/gauntlet/GameOverScreen.tsx`
</verification>

<success_criteria>
- [ ] useCountdownToMidnight hook returns formatted countdown string (LEAD-07 timer)
- [ ] SubmitScoreModal validates nickname and submits score (LEAD-02)
- [ ] LeaderboardScreen displays top 100 with rankings (LEAD-03)
- [ ] LeaderboardScreen shows "Near You" section (LEAD-06)
- [ ] LeaderboardScreen shows countdown to reset (LEAD-07)
- [ ] GameOverScreen shows personal best (LEAD-04)
- [ ] GameOverScreen has Submit Score and View Leaderboard buttons
- [ ] All components styled consistently with Gauntlet dark/red theme
- [ ] All files committed to git
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete leaderboard UI: submission flow, top 100 view, near you section, countdown timer</what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Play Gauntlet until game over
    3. Verify personal best is shown
    4. Click "Submit Score" - enter nickname, submit
    5. Click "View Leaderboard" - see top 100 (may be empty initially)
    6. Verify countdown timer shows time to midnight UTC
    7. Verify "Near You" section appears if you submitted
    8. Click Back to return to game over
    9. Verify "Submit Score" is disabled after submission
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/21-leaderboard-system/21-05-SUMMARY.md`
</output>
