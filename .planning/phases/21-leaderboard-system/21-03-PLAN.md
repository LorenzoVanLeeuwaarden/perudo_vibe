---
phase: 21-leaderboard-system
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - party/leaderboard.ts
  - src/lib/leaderboard-api.ts
autonomous: true

must_haves:
  truths:
    - "POST /party/leaderboard accepts nickname+score and inserts into D1"
    - "Server rejects invalid scores (negative, >1000, non-numeric)"
    - "Server rejects invalid nicknames (>30 chars, non-alphanumeric)"
    - "GET /party/leaderboard returns top 100 with cursor pagination"
    - "GET /party/leaderboard/rank returns player's rank for given score"
    - "GET /party/leaderboard/near returns 3 scores above and 3 below"
  artifacts:
    - path: "party/leaderboard.ts"
      provides: "Complete leaderboard API endpoints"
      exports: ["default"]
    - path: "src/lib/leaderboard-api.ts"
      provides: "Frontend API client functions"
      exports: ["fetchLeaderboard", "submitScore", "getPlayerRank", "getNearbyScores"]
  key_links:
    - from: "src/lib/leaderboard-api.ts"
      to: "party/leaderboard.ts"
      via: "fetch to /party/leaderboard"
      pattern: "fetch.*party.*leaderboard"
    - from: "party/leaderboard.ts"
      to: "D1 database"
      via: "env.LEADERBOARD_DB"
      pattern: "db\\.prepare"
---

<objective>
Implement complete leaderboard API with D1 queries and frontend client

Purpose: Enable score submission, retrieval, ranking, and "near you" queries (LEAD-01, LEAD-02, LEAD-03, LEAD-05, LEAD-06)
Output: Full leaderboard Worker implementation, frontend API client
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-leaderboard-system/21-RESEARCH.md
@.planning/phases/21-leaderboard-system/21-01-SUMMARY.md

@party/leaderboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement leaderboard Worker endpoints</name>
  <files>party/leaderboard.ts</files>
  <action>
Replace skeleton with full implementation:

**Validation constants:**
```typescript
const MAX_SCORE = 1000;
const MIN_SCORE = 0;
const MAX_NICKNAME_LENGTH = 30;
const NICKNAME_REGEX = /^[a-zA-Z0-9\s]+$/;
```

**POST / - Submit score:**
- Parse JSON body { nickname, score }
- Validate: nickname length 2-30, alphanumeric+spaces only
- Validate: score 0-1000 integer
- Insert into leaderboard table with current timestamp
- Return 201 on success, 400 on validation failure

**GET / - Fetch top 100:**
- Support cursor param for pagination (format: "score:id")
- Filter to today's scores: `submitted_at >= date('now', 'start of day')`
- Order by score DESC, id ASC
- Return { items: LeaderboardEntry[], nextCursor: string | null }
- Use cursor-based WHERE clause, NOT OFFSET

**GET /rank - Get player rank:**
- Query param: score
- Count entries with higher score: `SELECT COUNT(*) + 1 FROM leaderboard WHERE score > ?`
- Filter to today only
- Return { rank: number }

**GET /near - Get nearby scores:**
- Query param: score, id (optional, for tie-breaking)
- Get 3 scores above: `WHERE score > ? ORDER BY score ASC LIMIT 3` (reverse result)
- Get 3 scores below: `WHERE score < ? ORDER BY score DESC LIMIT 3`
- Return { above: LeaderboardEntry[], below: LeaderboardEntry[] }

**CORS headers:** Add Access-Control-Allow-Origin: * for all responses (PartyKit runs on different domain).

**Error handling:** Wrap all D1 operations in try/catch, return 500 with error message on failure.
  </action>
  <verify>`npx tsc --noEmit party/leaderboard.ts` compiles without errors</verify>
  <done>Leaderboard Worker has POST, GET /, GET /rank, GET /near endpoints with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create frontend API client</name>
  <files>src/lib/leaderboard-api.ts</files>
  <action>
Create typed API client for leaderboard operations:

```typescript
// Use NEXT_PUBLIC env var for PartyKit host
const getLeaderboardUrl = () => {
  const host = process.env.NEXT_PUBLIC_PARTYKIT_HOST || 'localhost:1999';
  const protocol = host.includes('localhost') ? 'http' : 'https';
  return `${protocol}://${host}/parties/leaderboard/global`;
};

export interface LeaderboardEntry {
  id: number;
  nickname: string;
  score: number;
  submitted_at: string;
}

export interface LeaderboardResponse {
  items: LeaderboardEntry[];
  nextCursor: string | null;
}

export interface NearbyScoresResponse {
  above: LeaderboardEntry[];
  below: LeaderboardEntry[];
}

export async function fetchLeaderboard(cursor?: string): Promise<LeaderboardResponse>
export async function submitScore(nickname: string, score: number): Promise<void>
export async function getPlayerRank(score: number): Promise<number>
export async function getNearbyScores(score: number): Promise<NearbyScoresResponse>
```

Implementation details:
- Use getLeaderboardUrl() for base URL construction
- Handle non-ok responses by throwing Error with response text
- submitScore should validate nickname client-side before sending (2-30 chars, alphanumeric)
- All functions should handle network errors gracefully

Note: The PartyKit URL format is /parties/{party-name}/{room-id}. Use "global" as room-id for the leaderboard (shared across all players).
  </action>
  <verify>`npx tsc --noEmit src/lib/leaderboard-api.ts` compiles without errors</verify>
  <done>Frontend API client with type-safe functions for all leaderboard operations</done>
</task>

</tasks>

<verification>
1. Worker compiles: `npx tsc --noEmit party/leaderboard.ts`
2. Client compiles: `npx tsc --noEmit src/lib/leaderboard-api.ts`
3. Exports correct: `grep "export" src/lib/leaderboard-api.ts | wc -l` shows 4+ exports
4. No lint errors: `npm run lint -- --quiet`
</verification>

<success_criteria>
- [ ] party/leaderboard.ts handles POST, GET, GET /rank, GET /near endpoints
- [ ] Server-side validation rejects invalid scores and nicknames (LEAD-05)
- [ ] Cursor-based pagination for top 100 (LEAD-03)
- [ ] Rank query returns correct position (LEAD-06)
- [ ] Near query returns 3 above and 3 below (LEAD-06)
- [ ] src/lib/leaderboard-api.ts provides typed client functions
- [ ] CORS headers allow cross-origin requests
- [ ] All files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/21-leaderboard-system/21-03-SUMMARY.md`
</output>
