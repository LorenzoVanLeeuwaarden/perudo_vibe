---
phase: 21-leaderboard-system
plan: 04
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - party/leaderboard-reset.ts
  - wrangler.jsonc
autonomous: true

must_haves:
  truths:
    - "Scheduled Worker runs at midnight UTC daily"
    - "Reset deletes all entries from leaderboard table"
    - "Reset optionally archives top 10 to history table"
    - "Cron trigger configured in wrangler.jsonc"
  artifacts:
    - path: "party/leaderboard-reset.ts"
      provides: "Scheduled Worker for daily leaderboard reset"
      exports: ["default"]
    - path: "wrangler.jsonc"
      provides: "Cron trigger configuration"
      contains: "0 0 * * *"
  key_links:
    - from: "wrangler.jsonc"
      to: "party/leaderboard-reset.ts"
      via: "cron triggers"
      pattern: "triggers.*crons"
    - from: "party/leaderboard-reset.ts"
      to: "D1 database"
      via: "env.LEADERBOARD_DB"
      pattern: "env\\.LEADERBOARD_DB"
---

<objective>
Implement scheduled Worker for daily leaderboard reset at midnight UTC

Purpose: Reset leaderboard daily to create fresh competition cycles (LEAD-07 reset mechanism)
Output: Scheduled Worker with cron trigger, updated wrangler config
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-leaderboard-system/21-RESEARCH.md
@.planning/phases/21-leaderboard-system/21-01-SUMMARY.md

@wrangler.jsonc
@migrations/0001_create_leaderboard.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scheduled reset Worker</name>
  <files>party/leaderboard-reset.ts</files>
  <action>
Create Cloudflare scheduled Worker for daily reset:

```typescript
interface Env {
  LEADERBOARD_DB: D1Database;
}

export default {
  async scheduled(
    controller: ScheduledController,
    env: Env,
    ctx: ExecutionContext
  ): Promise<void> {
    console.log('[CRON] Daily leaderboard reset triggered at', new Date().toISOString());

    const db = env.LEADERBOARD_DB;

    try {
      // Archive yesterday's top 10 (if history table exists)
      await db.prepare(`
        INSERT INTO leaderboard_history (nickname, score, date, rank)
        SELECT
          nickname,
          score,
          date('now', '-1 day'),
          ROW_NUMBER() OVER (ORDER BY score DESC, id ASC)
        FROM leaderboard
        ORDER BY score DESC, id ASC
        LIMIT 10
      `).run();

      // Delete all entries from current leaderboard
      const result = await db.prepare('DELETE FROM leaderboard').run();

      console.log('[CRON] Reset complete. Deleted', result.meta.changes, 'entries');
    } catch (error) {
      console.error('[CRON] Reset failed:', error);
      throw error; // Re-throw to mark cron as failed
    }
  }
};
```

Notes:
- Use ROW_NUMBER() window function for ranking in archive
- Archive INSERT may fail if leaderboard_history table doesn't exist - that's OK for MVP
- Log entry count for debugging
- Re-throw errors so Cloudflare marks the cron execution as failed
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit party/leaderboard-reset.ts`</verify>
  <done>Scheduled Worker archives top 10 and clears leaderboard</done>
</task>

<task type="auto">
  <name>Task 2: Configure cron trigger in wrangler</name>
  <files>wrangler.jsonc</files>
  <action>
Update wrangler.jsonc to add cron trigger for midnight UTC:

```jsonc
{
  "$schema": "https://json.schemastore.org/wrangler",
  "name": "faroleo",
  "main": "party/index.ts",
  "compatibility_date": "2024-01-01",
  "d1_databases": [
    {
      "binding": "LEADERBOARD_DB",
      "database_name": "gauntlet-leaderboard",
      "database_id": "YOUR_DATABASE_ID_HERE"
    }
  ],
  "triggers": {
    "crons": ["0 0 * * *"]
  }
}
```

Cron expression "0 0 * * *" means:
- 0 minutes
- 0 hours (midnight)
- Every day of month
- Every month
- Every day of week
= Midnight UTC daily

Note: The scheduled handler in party/leaderboard-reset.ts is separate from the main PartyKit server. Wrangler will invoke the scheduled export when the cron fires.
  </action>
  <verify>`cat wrangler.jsonc | grep -A2 triggers` shows crons array with "0 0 * * *"</verify>
  <done>wrangler.jsonc has cron trigger for midnight UTC daily reset</done>
</task>

</tasks>

<verification>
1. Reset Worker compiles: `npx tsc --noEmit party/leaderboard-reset.ts`
2. Cron configured: `grep "0 0" wrangler.jsonc`
3. Scheduled export exists: `grep "scheduled" party/leaderboard-reset.ts`
4. No lint errors: `npm run lint -- --quiet`
</verification>

<success_criteria>
- [ ] party/leaderboard-reset.ts exports scheduled handler
- [ ] Handler archives top 10 to history table
- [ ] Handler deletes all current leaderboard entries
- [ ] wrangler.jsonc includes triggers.crons with "0 0 * * *"
- [ ] TypeScript compiles without errors
- [ ] All files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/21-leaderboard-system/21-04-SUMMARY.md`
</output>
