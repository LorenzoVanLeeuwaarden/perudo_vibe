---
phase: 18-lobby-unification
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/components/RoomLobby.tsx
autonomous: true

must_haves:
  truths:
    - "Multiplayer lobby displays with unified panel structure (header with back button, scrollable content zone, footer with Start Game)"
    - "Multiplayer lobby uses static gradient background instead of animated shader"
    - "Back button shows leave confirmation dialog before exiting"
    - "Start Game button is fixed at bottom of panel (not top)"
    - "Player list, settings button, and share section remain in content zone"
    - "Connection status indicator remains visible (outside panel, top-right)"
  artifacts:
    - path: "src/components/RoomLobby.tsx"
      provides: "Multiplayer lobby using LobbyLayout"
      contains: "LobbyLayout"
  key_links:
    - from: "src/components/RoomLobby.tsx"
      to: "src/components/LobbyLayout.tsx"
      via: "import and render"
      pattern: "import.*LobbyLayout"
    - from: "src/components/RoomLobby.tsx"
      to: "src/components/LeaveConfirmDialog.tsx"
      via: "confirmBack prop triggers dialog"
      pattern: "confirmBack.*true"
---

<objective>
Integrate multiplayer lobby with LobbyLayout while preserving mode-specific features.

Purpose: Complete lobby unification by migrating RoomLobby to use the shared LobbyLayout foundation, moving Start Game to footer, and adding leave confirmation.

Output: RoomLobby renders via LobbyLayout with all multiplayer features preserved (player list, settings, share, kick, connection status).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-lobby-unification/18-CONTEXT.md
@.planning/phases/18-lobby-unification/18-RESEARCH.md
@.planning/phases/18-lobby-unification/18-01-SUMMARY.md

@src/components/RoomLobby.tsx (current multiplayer lobby)
@src/components/LobbyLayout.tsx (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor RoomLobby to use LobbyLayout</name>
  <files>src/components/RoomLobby.tsx</files>
  <action>
Refactor RoomLobby to use LobbyLayout while preserving all multiplayer features:

1. Import LobbyLayout (remove ShaderBackground import - LobbyLayout handles background):
   ```typescript
   import { LobbyLayout } from '@/components/LobbyLayout';
   ```

2. Remove these elements (LobbyLayout provides them):
   - The `<ShaderBackground />` component
   - The `<div className="scanlines-overlay" />` (keep if LobbyLayout doesn't include it, otherwise remove)
   - The outer `<main>` wrapper
   - The back button (lines ~64-74)
   - The CasinoLogo motion.div wrapper
   - The `<motion.div initial...` lobby panel wrapper

3. Keep these elements OUTSIDE LobbyLayout (fixed position):
   - Connection status indicator (lines ~77-106) - render BEFORE LobbyLayout, keep fixed positioning

4. Restructure to use LobbyLayout:
   ```tsx
   return (
     <>
       {/* Connection status - keep outside LobbyLayout, fixed position */}
       <motion.div
         initial={{ opacity: 0 }}
         animate={{ opacity: 1 }}
         className="fixed top-4 right-4 z-50 ..."
       >
         {/* connection status content */}
       </motion.div>

       <LobbyLayout
         title={`Room: ${roomCode}`}
         onBack={handleBack}
         confirmBack={true}
         backConfirmTitle="Leave Lobby?"
         backConfirmMessage="You will be removed from the game room."
         headerRight={null}  // Connection status is outside, not in header
         footer={
           isHost ? (
             <motion.button
               whileHover={canStart ? { scale: 1.02 } : {}}
               whileTap={canStart ? { scale: 0.98 } : {}}
               onClick={handleStartGame}
               disabled={!canStart}
               className={`w-full py-4 rounded-lg font-bold text-lg transition-colors ${
                 canStart
                   ? 'bg-gold-accent text-purple-deep hover:bg-gold-accent/90'
                   : 'bg-purple-mid/50 text-white-soft/50 cursor-not-allowed'
               }`}
             >
               Start Game
             </motion.button>
           ) : (
             <div className="text-center py-4">
               <p className="text-white-soft/60">
                 Waiting for host to start...
               </p>
             </div>
           )
         }
       >
         {/* Content: Player list, settings button, share section */}
         <div className="space-y-6">
           {/* Player List section */}
           <div>
             <h3 className="text-sm font-bold text-white-soft/80 uppercase tracking-wider mb-3">
               Players ({connectedCount}/6)
             </h3>
             <PlayerList
               players={roomState.players}
               myPlayerId={myPlayerId}
               isHost={isHost}
               onKickPlayer={(playerId) => setShowKickDialog(playerId)}
             />
           </div>

           {/* Settings section */}
           <div>
             <motion.button
               whileHover={{ scale: 1.02 }}
               whileTap={{ scale: 0.98 }}
               onClick={() => setShowSettings(true)}
               className="w-full py-3 rounded-lg bg-purple-mid border border-purple-glow text-white-soft flex items-center justify-center gap-2"
             >
               <Settings className="w-4 h-4" />
               {isHost ? 'Configure Game' : 'Game Settings'}
             </motion.button>
           </div>

           {/* Share section */}
           <div className="pt-4 border-t border-purple-mid">
             <RoomShare roomCode={roomCode} playerColor={playerColor} />
           </div>
         </div>
       </LobbyLayout>

       {/* Dialogs remain at bottom */}
       <KickConfirmDialog ... />
       <GameSettingsModal ... />
     </>
   );
   ```

5. Update handleBack to NOT call clearPreferredMode/router.push directly - LobbyLayout's confirmBack handles showing dialog, then calls onBack which should do the navigation:
   ```typescript
   const handleBack = () => {
     clearPreferredMode();
     router.push('/');
   };
   ```
   (This remains the same - LobbyLayout will call it after user confirms)

Key changes from current structure:
- Start Game moves from TOP of panel to FOOTER (per CONTEXT.md)
- Back button handled by LobbyLayout header
- Leave confirmation via LobbyLayout's confirmBack=true
- Static background via LobbyLayout (no more ShaderBackground)
- Player list, settings, share remain in content zone
  </action>
  <verify>
Run dev server: `npm run dev` (should compile without errors)
TypeScript compiles: `npx tsc --noEmit`
Visual check in multiplayer lobby:
- Static gradient background (no animated shader)
- Back button in header (top-left of panel)
- Clicking back shows "Leave Lobby?" confirmation
- Connection status visible (top-right, outside panel)
- Player list visible in content zone
- Settings button visible
- Share section visible with divider
- Start Game button at BOTTOM of panel (footer)
  </verify>
  <done>
Multiplayer lobby renders via LobbyLayout with:
- Static gradient background
- Back button in unified header with leave confirmation
- Connection status preserved (fixed position outside panel)
- Content zone with player list, settings, share
- Footer with Start Game button (moved from top)
- All mode-specific features preserved (kick, settings modal, share)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify both lobbies match visually and functionally</name>
  <files>None (verification only)</files>
  <action>
Comprehensive verification that both lobbies now share the unified foundation:

1. Visual comparison checklist:
   - [ ] Both lobbies have static gradient background (not animated)
   - [ ] Both lobbies have back button in same position (header, top-left of panel)
   - [ ] Both lobbies have action button at bottom (footer)
   - [ ] Panel styling matches (retro-panel, same padding)
   - [ ] Header structure identical (back button left, title center/right)

2. Functional verification:
   - Single-player:
     - [ ] Back returns to mode selection immediately (no confirmation)
     - [ ] Opponent count +/- works
     - [ ] Settings gear opens modal
     - [ ] Start Game begins game
   - Multiplayer:
     - [ ] Back shows confirmation dialog
     - [ ] Confirming leave returns to home
     - [ ] Canceling stays in lobby
     - [ ] Player list shows connected players
     - [ ] Kick button works (host only)
     - [ ] Settings button opens modal
     - [ ] Share section displays room code and copy button
     - [ ] Start Game works (host only, when 2+ players)

3. Edge cases:
   - [ ] Mobile viewport: content scrolls if needed, footer stays visible
   - [ ] Connection status visible on multiplayer (not covered by panel)

Run through test checklist manually since this is UI verification.
  </action>
  <verify>
Manual testing of both lobbies confirms:
- Unified visual structure
- All functionality preserved
- No regressions
  </verify>
  <done>
Both lobbies visually unified and fully functional. LOBBY-01, LOBBY-02, LOBBY-03 requirements satisfied.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (TypeScript compiles)
- Multiplayer lobby displays with unified structure
- Back button shows leave confirmation before exiting
- Start Game button is at bottom of panel
- All multiplayer features work (player list, kick, settings, share)
- Connection status remains visible outside panel
- Both lobbies visually match in structure
</verification>

<success_criteria>
- RoomLobby refactored to use LobbyLayout
- Leave confirmation works for multiplayer
- Start Game moved to footer
- All multiplayer-specific features preserved
- Visual parity between single-player and multiplayer lobbies
- LOBBY-01, LOBBY-02, LOBBY-03 requirements complete
</success_criteria>

<output>
After completion, create `.planning/phases/18-lobby-unification/18-02-SUMMARY.md`
</output>
