---
phase: 11-frontend-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - .env.production
  - public/_redirects
autonomous: true

must_haves:
  truths:
    - "Next.js builds successfully with static export"
    - "Build output directory (out/) contains valid HTML/CSS/JS"
    - "Production environment variable is inlined in build"
  artifacts:
    - path: "next.config.ts"
      provides: "Static export configuration"
      contains: "output: 'export'"
    - path: ".env.production"
      provides: "Production PartyKit host URL"
      contains: "NEXT_PUBLIC_PARTYKIT_HOST=perudo-vibe.lorenzovanleeuwaarden.partykit.dev"
    - path: "public/_redirects"
      provides: "SPA routing rules for Cloudflare Pages"
      contains: "/* /index.html 200"
    - path: "out/index.html"
      provides: "Built static home page"
      min_lines: 1
  key_links:
    - from: ".env.production"
      to: "out/_next/static/**/*.js"
      via: "build-time inlining"
      pattern: "perudo-vibe.lorenzovanleeuwaarden.partykit.dev"
---

<objective>
Configure Next.js for static export and create production environment configuration.

Purpose: Prepare the codebase for Cloudflare Pages deployment by enabling static export and configuring production environment variables.

Output: A buildable static site with production configuration, ready for deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-frontend-configuration/11-CONTEXT.md
@.planning/phases/11-frontend-configuration/11-RESEARCH.md
@.planning/phases/10-backend-deployment/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js for static export</name>
  <files>next.config.ts</files>
  <action>
Update next.config.ts to enable static export for Cloudflare Pages deployment:

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: 'export',
  trailingSlash: true,
  images: {
    unoptimized: true,
  },
};

export default nextConfig;
```

Key settings:
- `output: 'export'` - Generates static HTML/CSS/JS in out/ folder
- `trailingSlash: true` - Generates /room/[code]/index.html for consistent routing
- `images.unoptimized: true` - Required because Next.js Image Optimization requires a server

Do NOT add any other settings. Keep it minimal.
  </action>
  <verify>File contains all three settings: output: 'export', trailingSlash: true, images.unoptimized: true</verify>
  <done>next.config.ts configured for static export with trailing slashes and unoptimized images</done>
</task>

<task type="auto">
  <name>Task 2: Create production environment and SPA routing files</name>
  <files>.env.production, public/_redirects</files>
  <action>
Create two files for production deployment:

1. Create `.env.production` (at project root):
```bash
NEXT_PUBLIC_PARTYKIT_HOST=perudo-vibe.lorenzovanleeuwaarden.partykit.dev
```

Important: No protocol prefix (no https://), just the host. This file is committed to git since it only contains public values.

2. Create `public/_redirects`:
```
/* /index.html 200
```

This tells Cloudflare Pages to serve index.html for any route that doesn't match a static file, enabling client-side routing for dynamic routes like /room/ABC123.
  </action>
  <verify>
- .env.production exists and contains NEXT_PUBLIC_PARTYKIT_HOST with production URL (no https:// prefix)
- public/_redirects exists and contains the SPA catch-all rule
  </verify>
  <done>Production environment file and SPA routing rules created</done>
</task>

<task type="auto">
  <name>Task 3: Build and verify static export</name>
  <files>out/</files>
  <action>
Run the build to generate static export and verify it works:

```bash
npm run build
```

After build completes, verify:
1. `out/` directory exists
2. `out/index.html` exists (home page)
3. `out/_redirects` exists (copied from public/)
4. `out/room/` directory exists (dynamic route template)
5. Production host is inlined: `grep -r "perudo-vibe.lorenzovanleeuwaarden.partykit.dev" out/`

If build fails, check for:
- Missing images.unoptimized setting (error about Image Optimization)
- TypeScript errors (run `tsc --noEmit` to check)
  </action>
  <verify>
Run these checks:
- `ls out/index.html` - file exists
- `ls out/_redirects` - file exists
- `ls out/room/` - directory exists
- `grep -r "perudo-vibe.lorenzovanleeuwaarden.partykit.dev" out/` - returns matches (host inlined)
  </verify>
  <done>Static export builds successfully with production configuration inlined</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors
2. `out/` directory contains index.html, _redirects, and _next/ folder
3. Production PartyKit host is inlined in JavaScript bundles
4. No references to localhost:1999 in production build
</verification>

<success_criteria>
- next.config.ts has static export configuration
- .env.production contains production PartyKit host
- public/_redirects contains SPA routing rule
- `npm run build` succeeds
- out/ directory contains complete static site
- Production host visible in build output
</success_criteria>

<output>
After completion, create `.planning/phases/11-frontend-configuration/11-01-SUMMARY.md`
</output>
