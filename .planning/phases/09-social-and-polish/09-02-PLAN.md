---
phase: 09-social-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/EmotePicker.tsx
  - src/components/EmoteBubble.tsx
  - src/components/GameBoard.tsx
  - src/stores/uiStore.ts
autonomous: true

must_haves:
  truths:
    - "Player can open emote picker during game"
    - "Player can select an emote and it sends to server"
    - "Emotes from any player appear as bubbles near their badge"
    - "Emote bubbles auto-dismiss after 2 seconds"
    - "Picker closes after selecting an emote"
  artifacts:
    - path: "src/components/EmotePicker.tsx"
      provides: "Button that opens 8-emoji grid picker"
      exports: ["EmotePicker"]
    - path: "src/components/EmoteBubble.tsx"
      provides: "Animated floating emoji bubble"
      exports: ["EmoteBubble"]
    - path: "src/components/GameBoard.tsx"
      provides: "Integration of emote system into game UI"
      contains: "EmotePicker"
    - path: "src/stores/uiStore.ts"
      provides: "Active emotes state for display"
      contains: "activeEmotes"
  key_links:
    - from: "src/components/EmotePicker.tsx"
      to: "GameBoard sendMessage"
      via: "onSelectEmote callback -> SEND_EMOTE"
      pattern: "SEND_EMOTE"
    - from: "src/components/GameBoard.tsx"
      to: "EMOTE_RECEIVED handler"
      via: "useEffect for message handling"
      pattern: "EMOTE_RECEIVED"
---

<objective>
Create emote picker UI and bubble display for real-time player reactions.

Purpose: Enable players to express themselves during gameplay with quick emoji reactions visible to all players.

Output: EmotePicker component, EmoteBubble component, integrated into GameBoard with proper message handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-social-and-polish/09-CONTEXT.md
@.planning/phases/09-social-and-polish/09-RESEARCH.md
@src/components/GameBoard.tsx
@src/stores/uiStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmotePicker and EmoteBubble components</name>
  <files>src/components/EmotePicker.tsx, src/components/EmoteBubble.tsx</files>
  <action>
Create src/components/EmotePicker.tsx:

```typescript
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Smile } from 'lucide-react';

// 8 preset emotes per CONTEXT.md decision
const EMOTES = ['ðŸ˜‚', 'ðŸŽ‰', 'ðŸ˜±', 'ðŸ‘', 'ðŸ”¥', 'ðŸ’€', 'ðŸ¤”', 'ðŸ‘€'];

interface EmotePickerProps {
  onSelect: (emote: string) => void;
  disabled?: boolean;
}

export function EmotePicker({ onSelect, disabled }: EmotePickerProps) {
  const [open, setOpen] = useState(false);

  const handleSelect = (emote: string) => {
    onSelect(emote);
    setOpen(false);
  };

  return (
    <div className="relative">
      <motion.button
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        onClick={() => setOpen(!open)}
        disabled={disabled}
        className={`p-2 rounded-lg bg-purple-mid/50 border border-purple-light/30
          hover:bg-purple-mid/70 transition-colors ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
        aria-label="Open emote picker"
      >
        <Smile className="w-5 h-5 text-white-soft" />
      </motion.button>

      <AnimatePresence>
        {open && (
          <>
            {/* Backdrop to close picker */}
            <div
              className="fixed inset-0 z-40"
              onClick={() => setOpen(false)}
            />

            <motion.div
              initial={{ opacity: 0, scale: 0.9, y: 10 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.9, y: 10 }}
              transition={{ type: 'spring', stiffness: 400, damping: 25 }}
              className="absolute bottom-full mb-2 right-0 p-2 bg-purple-deep border border-purple-light/30
                rounded-lg shadow-xl z-50 grid grid-cols-4 gap-1"
            >
              {EMOTES.map(emote => (
                <motion.button
                  key={emote}
                  whileHover={{ scale: 1.15 }}
                  whileTap={{ scale: 0.9 }}
                  onClick={() => handleSelect(emote)}
                  className="text-2xl p-2 hover:bg-purple-mid/50 rounded transition-colors"
                >
                  {emote}
                </motion.button>
              ))}
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
}
```

Create src/components/EmoteBubble.tsx:

```typescript
'use client';

import { motion } from 'framer-motion';
import { useEffect, useState } from 'react';

interface EmoteBubbleProps {
  emote: string;
  onComplete: () => void;
}

export function EmoteBubble({ emote, onComplete }: EmoteBubbleProps) {
  const [visible, setVisible] = useState(true);

  useEffect(() => {
    // Auto-dismiss after 2 seconds
    const timer = setTimeout(() => {
      setVisible(false);
    }, 2000);

    return () => clearTimeout(timer);
  }, []);

  // Trigger onComplete after exit animation
  useEffect(() => {
    if (!visible) {
      const exitTimer = setTimeout(onComplete, 300);
      return () => clearTimeout(exitTimer);
    }
  }, [visible, onComplete]);

  if (!visible) {
    return (
      <motion.div
        initial={{ opacity: 1, scale: 1, y: 0 }}
        animate={{ opacity: 0, scale: 0, y: -20 }}
        transition={{ duration: 0.3 }}
        className="absolute -top-10 left-1/2 -translate-x-1/2 text-3xl pointer-events-none"
      >
        {emote}
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0, y: 10 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      transition={{ type: 'spring', stiffness: 400, damping: 20 }}
      className="absolute -top-10 left-1/2 -translate-x-1/2 text-3xl pointer-events-none"
    >
      {emote}
    </motion.div>
  );
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - components compile without errors</verify>
  <done>EmotePicker shows 8 preset emojis in a 4x2 grid, opens on button click, closes on selection or backdrop click. EmoteBubble animates in, stays for 2 seconds, animates out, then calls onComplete.</done>
</task>

<task type="auto">
  <name>Task 2: Add emote state to uiStore</name>
  <files>src/stores/uiStore.ts</files>
  <action>
Update src/stores/uiStore.ts to add emote tracking:

1. Add interface for active emote:
```typescript
interface ActiveEmote {
  id: string;  // Unique ID for React key
  playerId: string;
  emote: string;
}
```

2. Add to UIStore interface (in non-persisted section):
```typescript
// Emote state (not persisted)
activeEmotes: ActiveEmote[];
```

3. Add actions:
```typescript
addEmote: (playerId: string, emote: string) => void;
removeEmote: (id: string) => void;
```

4. Add initial state and action implementations:
```typescript
// In initial state
activeEmotes: [],

// In actions
addEmote: (playerId, emote) => set((state) => ({
  activeEmotes: [
    ...state.activeEmotes.slice(-5), // Keep max 6 active (limit memory)
    { id: `${Date.now()}-${playerId}`, playerId, emote }
  ]
})),
removeEmote: (id) => set((state) => ({
  activeEmotes: state.activeEmotes.filter(e => e.id !== id)
})),
```

5. Update resetAnimationState to also clear activeEmotes:
```typescript
resetAnimationState: () => set({
  // ... existing resets ...
  activeEmotes: [],
}),
```
  </action>
  <verify>Run `npx tsc --noEmit` - uiStore compiles without errors</verify>
  <done>uiStore has activeEmotes array, addEmote action to add new emotes (with max 6 limit), removeEmote action to clean up after animation.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate emotes into GameBoard</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Update src/components/GameBoard.tsx:

1. Import new components and store actions:
```typescript
import { EmotePicker } from './EmotePicker';
import { EmoteBubble } from './EmoteBubble';
// Add to useUIStore destructuring:
const { activeEmotes, addEmote, removeEmote, ... } = useUIStore();
```

2. Add emote handler that sends message:
```typescript
const handleSendEmote = (emote: string) => {
  sendMessage({ type: 'SEND_EMOTE', emote, timestamp: Date.now() });
};
```

3. The parent component (room page) needs to handle EMOTE_RECEIVED messages and call addEmote. For now, add a comment in GameBoard indicating where emotes display.

4. Update PlayerDiceBadge render to include EmoteBubble overlay. Wrap each PlayerDiceBadge in a relative container:
```typescript
{players.map(player => {
  const playerEmotes = activeEmotes.filter(e => e.playerId === player.id);
  return (
    <div key={player.id} className="relative">
      <PlayerDiceBadge
        playerName={player.name}
        diceCount={player.diceCount}
        color={player.color as PlayerColor}
        isActive={player.id === gameState.currentTurnPlayerId}
        isEliminated={player.isEliminated}
        hasPalifico={gameState.isPalifico && player.id === gameState.roundStarterId}
        showThinking={player.id === gameState.currentTurnPlayerId && gameState.phase === 'bidding'}
        thinkingPrompt={player.id === myPlayerId ? 'Your turn' : 'Thinking'}
        showDisconnectedVisual={shouldShowDisconnectedVisual(player, currentTime)}
        isConnected={player.isConnected}
      />
      {/* Emote bubbles above player badge */}
      {playerEmotes.slice(-1).map(activeEmote => (
        <EmoteBubble
          key={activeEmote.id}
          emote={activeEmote.emote}
          onComplete={() => removeEmote(activeEmote.id)}
        />
      ))}
    </div>
  );
})}
```

5. Add EmotePicker to the UI. Place it in the bottom-right corner of the game area, near "Your Dice" panel but not blocking it. Add after the myHand display section:
```typescript
{/* Emote picker - only show during active game */}
{gameState.phase === 'bidding' && (
  <div className="fixed bottom-24 right-4 z-20">
    <EmotePicker
      onSelect={handleSendEmote}
      disabled={false}
    />
  </div>
)}
```

6. Note: The EMOTE_RECEIVED message handling should be done in the parent room page where useRoomConnection is used. Add a comment indicating this:
```typescript
// Note: EMOTE_RECEIVED messages are handled in the parent room page
// and call addEmote(playerId, emote) to trigger bubble display
```
  </action>
  <verify>Run `npx tsc --noEmit` - GameBoard compiles without errors. EmotePicker and EmoteBubble are imported and used.</verify>
  <done>GameBoard renders EmotePicker button during bidding phase. Each player badge has space for EmoteBubble overlay. handleSendEmote sends SEND_EMOTE message to server.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes without errors
2. EmotePicker.tsx exists and exports EmotePicker component
3. EmoteBubble.tsx exists and exports EmoteBubble component
4. GameBoard.tsx imports and renders EmotePicker
5. uiStore has activeEmotes state and addEmote/removeEmote actions
</verification>

<success_criteria>
- [ ] EmotePicker component created with 8 preset emojis in 4x2 grid
- [ ] EmotePicker opens/closes with animation, closes on selection
- [ ] EmoteBubble component created with spring animation and 2-second auto-dismiss
- [ ] uiStore has activeEmotes array and add/remove actions
- [ ] GameBoard renders EmotePicker during bidding phase
- [ ] GameBoard renders EmoteBubble for each player's active emote
- [ ] handleSendEmote sends SEND_EMOTE message to server
- [ ] All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-social-and-polish/09-02-SUMMARY.md`
</output>
