---
phase: 09-social-and-polish
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/GameResultsScreen.tsx
  - src/components/StatCard.tsx
  - src/components/DiceExplosion.tsx
  - src/components/VictoryScreen.tsx
  - src/hooks/useSoundEffects.ts
  - public/sounds/victory.mp3
  - public/sounds/pop.mp3
  - public/sounds/dice-rattle.mp3
autonomous: true
user_setup:
  - service: sound-files
    why: "Victory fanfare, pop, and dice rattle sounds"
    dashboard_config:
      - task: "Download royalty-free sound files from Pixabay or Freesound"
        location: "https://pixabay.com/sound-effects/ or https://freesound.org/"

must_haves:
  truths:
    - "Winner sees enhanced celebration with dice explosion animation"
    - "All players see game statistics after celebration"
    - "Stats show bids placed, dudo calls, calza calls, dice changes per player"
    - "Host can click Return to Lobby button from results screen"
    - "Sound effects play on victory and emote (when enabled)"
  artifacts:
    - path: "src/components/GameResultsScreen.tsx"
      provides: "Full-screen statistics display with player stat cards"
      exports: ["GameResultsScreen"]
    - path: "src/components/StatCard.tsx"
      provides: "Individual player statistics card"
      exports: ["StatCard"]
    - path: "src/components/DiceExplosion.tsx"
      provides: "Animated dice flying/bouncing effect"
      exports: ["DiceExplosion"]
    - path: "src/components/VictoryScreen.tsx"
      provides: "Enhanced celebration with dice explosion and sound"
      contains: "DiceExplosion"
    - path: "src/hooks/useSoundEffects.ts"
      provides: "Central hook for game sounds"
      exports: ["useSoundEffects"]
  key_links:
    - from: "src/components/GameResultsScreen.tsx"
      to: "RETURN_TO_LOBBY message"
      via: "onReturnToLobby callback"
      pattern: "RETURN_TO_LOBBY"
    - from: "src/components/VictoryScreen.tsx"
      to: "src/components/DiceExplosion.tsx"
      via: "DiceExplosion import"
      pattern: "DiceExplosion"
---

<objective>
Add game-end celebration, statistics display, and rematch flow UI.

Purpose: Create a rewarding end-game experience with celebration animation, detailed statistics for each player, and easy rematch flow via return-to-lobby button.

Output: Enhanced VictoryScreen with dice explosion, GameResultsScreen with stat cards, sound effects hook, and full integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-social-and-polish/09-CONTEXT.md
@.planning/phases/09-social-and-polish/09-RESEARCH.md
@src/components/VictoryScreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sound effects hook and placeholder sound files</name>
  <files>src/hooks/useSoundEffects.ts, public/sounds/victory.mp3, public/sounds/pop.mp3, public/sounds/dice-rattle.mp3</files>
  <action>
First, install the use-sound library:
```bash
npm install use-sound
```

Create src/hooks/useSoundEffects.ts:

```typescript
'use client';

import { useCallback } from 'react';
import useSound from 'use-sound';
import { useUIStore } from '@/stores/uiStore';

/**
 * Central hook for all game sound effects.
 * Respects user's soundEnabled preference from uiStore.
 */
export function useSoundEffects() {
  const soundEnabled = useUIStore(s => s.soundEnabled);

  const [playVictorySound] = useSound('/sounds/victory.mp3', {
    soundEnabled,
    volume: 0.6,
  });

  const [playPopSound] = useSound('/sounds/pop.mp3', {
    soundEnabled,
    volume: 0.4,
  });

  const [playDiceRattleSound] = useSound('/sounds/dice-rattle.mp3', {
    soundEnabled,
    volume: 0.5,
  });

  // Wrap in useCallback for stable references
  const playVictory = useCallback(() => {
    playVictorySound();
  }, [playVictorySound]);

  const playPop = useCallback(() => {
    playPopSound();
  }, [playPopSound]);

  const playDiceRattle = useCallback(() => {
    playDiceRattleSound();
  }, [playDiceRattleSound]);

  return {
    playVictory,
    playPop,
    playDiceRattle,
    soundEnabled,
  };
}
```

Create the public/sounds directory and add placeholder MP3 files. For now, create simple 1-second silent MP3 files as placeholders:

```bash
mkdir -p public/sounds
# The actual sound files need to be downloaded from royalty-free sources
# For now, we'll create placeholder files that will be replaced
```

Note: Create a SOUNDS_README.md in public/sounds explaining where to get the actual files:

Create public/sounds/README.md:
```markdown
# Sound Effects

These sound files need to be downloaded from royalty-free sources:

## victory.mp3
- Purpose: Plays when a player wins
- Suggested: Fanfare, celebration, trumpet flourish
- Sources: Pixabay "victory fanfare", Freesound "celebration"

## pop.mp3
- Purpose: Plays when an emote is sent
- Suggested: Short pop/click sound
- Sources: Pixabay "pop sound", Freesound "ui click"

## dice-rattle.mp3
- Purpose: Plays during dice explosion animation
- Suggested: Dice rolling/rattling sound
- Sources: Pixabay "dice roll", Freesound "dice shake"

Download and rename files to match the expected names.
```

For the actual implementation, use 1-byte placeholder files or leave the directory structure ready. The hooks will gracefully handle missing files (just won't play sound).

Alternative: Use data URLs for tiny placeholder sounds to avoid 404 errors:
Actually, use-sound handles missing files gracefully by just not playing. So just ensure the directory exists.
  </action>
  <verify>Run `npm install use-sound && npx tsc --noEmit` - use-sound installed and hook compiles</verify>
  <done>useSoundEffects hook created with playVictory, playPop, playDiceRattle functions. Sound files directory created with README explaining where to source files.</done>
</task>

<task type="auto">
  <name>Task 2: Create DiceExplosion, StatCard, and GameResultsScreen components</name>
  <files>src/components/DiceExplosion.tsx, src/components/StatCard.tsx, src/components/GameResultsScreen.tsx</files>
  <action>
Create src/components/DiceExplosion.tsx:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import { Dice } from './Dice';
import type { PlayerColor } from '@/lib/types';

interface ExplodingDie {
  id: number;
  x: number;
  y: number;
  vx: number;
  vy: number;
  rotation: number;
  rotationSpeed: number;
  value: number;
  life: number;
}

interface DiceExplosionProps {
  color: PlayerColor;
  onComplete?: () => void;
}

export function DiceExplosion({ color, onComplete }: DiceExplosionProps) {
  const [dice, setDice] = useState<ExplodingDie[]>([]);

  useEffect(() => {
    // Create initial explosion of 12 dice from center
    const centerX = typeof window !== 'undefined' ? window.innerWidth / 2 : 200;
    const centerY = typeof window !== 'undefined' ? window.innerHeight / 2 : 200;

    const initialDice: ExplodingDie[] = [];
    for (let i = 0; i < 12; i++) {
      const angle = (Math.PI * 2 * i) / 12 + Math.random() * 0.5;
      const speed = 8 + Math.random() * 8;
      initialDice.push({
        id: Date.now() + i,
        x: centerX,
        y: centerY,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed - 8, // Upward bias
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 25,
        value: Math.floor(Math.random() * 6) + 1,
        life: 1,
      });
    }
    setDice(initialDice);

    // Animate physics
    const interval = setInterval(() => {
      setDice(prev => {
        const updated = prev
          .map(d => ({
            ...d,
            x: d.x + d.vx,
            y: d.y + d.vy,
            vy: d.vy + 0.4, // Gravity
            vx: d.vx * 0.99, // Air resistance
            rotation: d.rotation + d.rotationSpeed,
            life: d.life - 0.008,
          }))
          .filter(d => d.life > 0);

        if (updated.length === 0) {
          clearInterval(interval);
          onComplete?.();
        }

        return updated;
      });
    }, 16);

    return () => clearInterval(interval);
  }, [onComplete]);

  return (
    <div className="fixed inset-0 pointer-events-none z-30 overflow-hidden">
      {dice.map(d => (
        <div
          key={d.id}
          className="absolute"
          style={{
            left: d.x,
            top: d.y,
            transform: `translate(-50%, -50%) rotate(${d.rotation}deg) scale(${0.5 + d.life * 0.5})`,
            opacity: d.life,
          }}
        >
          <Dice value={d.value} color={color} size="sm" />
        </div>
      ))}
    </div>
  );
}
```

Create src/components/StatCard.tsx:

```typescript
'use client';

import { motion } from 'framer-motion';
import { Target, ThumbsUp, ThumbsDown, Dice1, Trophy } from 'lucide-react';
import type { PlayerColor } from '@/lib/types';
import { PLAYER_COLORS } from '@/lib/types';

interface PlayerStats {
  bidsPlaced: number;
  dudosCalled: number;
  dudosSuccessful: number;
  calzasCalled: number;
  calzasSuccessful: number;
  diceLost: number;
  diceGained: number;
}

interface StatCardProps {
  playerName: string;
  color: PlayerColor;
  stats: PlayerStats;
  isWinner: boolean;
}

export function StatCard({ playerName, color, stats, isWinner }: StatCardProps) {
  const colorConfig = PLAYER_COLORS[color];
  const dudoAccuracy = stats.dudosCalled > 0
    ? Math.round((stats.dudosSuccessful / stats.dudosCalled) * 100)
    : 0;
  const calzaAccuracy = stats.calzasCalled > 0
    ? Math.round((stats.calzasSuccessful / stats.calzasCalled) * 100)
    : 0;

  return (
    <motion.div
      className="retro-panel p-4 relative overflow-hidden"
      style={{
        borderColor: isWinner ? '#ffd700' : colorConfig.border,
        boxShadow: isWinner ? '0 0 20px rgba(255, 215, 0, 0.3)' : undefined,
      }}
    >
      {isWinner && (
        <div className="absolute top-2 right-2">
          <Trophy className="w-6 h-6 text-gold-accent" />
        </div>
      )}

      {/* Player name with color indicator */}
      <div className="flex items-center gap-2 mb-3">
        <div
          className="w-4 h-4 rounded-full"
          style={{ backgroundColor: colorConfig.primary }}
        />
        <h3 className="font-bold text-lg text-white-soft">{playerName}</h3>
      </div>

      {/* Stats grid */}
      <div className="grid grid-cols-2 gap-2 text-sm">
        <div className="flex items-center gap-2">
          <Target className="w-4 h-4 text-purple-light" />
          <span className="text-white-soft/70">Bids:</span>
          <span className="text-white-soft font-medium">{stats.bidsPlaced}</span>
        </div>

        <div className="flex items-center gap-2">
          <Dice1 className="w-4 h-4 text-purple-light" />
          <span className="text-white-soft/70">Dice lost:</span>
          <span className="text-red-400 font-medium">{stats.diceLost}</span>
        </div>

        <div className="flex items-center gap-2">
          <ThumbsDown className="w-4 h-4 text-orange-400" />
          <span className="text-white-soft/70">Dudo:</span>
          <span className="text-white-soft font-medium">
            {stats.dudosSuccessful}/{stats.dudosCalled}
            {stats.dudosCalled > 0 && (
              <span className="text-white-soft/50 ml-1">({dudoAccuracy}%)</span>
            )}
          </span>
        </div>

        <div className="flex items-center gap-2">
          <ThumbsUp className="w-4 h-4 text-green-400" />
          <span className="text-white-soft/70">Calza:</span>
          <span className="text-white-soft font-medium">
            {stats.calzasSuccessful}/{stats.calzasCalled}
            {stats.calzasCalled > 0 && (
              <span className="text-white-soft/50 ml-1">({calzaAccuracy}%)</span>
            )}
          </span>
        </div>
      </div>
    </motion.div>
  );
}
```

Create src/components/GameResultsScreen.tsx:

```typescript
'use client';

import { motion } from 'framer-motion';
import { Trophy, RotateCcw, Home } from 'lucide-react';
import { StatCard } from './StatCard';
import type { PlayerColor } from '@/lib/types';

interface PlayerStats {
  bidsPlaced: number;
  dudosCalled: number;
  dudosSuccessful: number;
  calzasCalled: number;
  calzasSuccessful: number;
  diceLost: number;
  diceGained: number;
}

interface GameStats {
  roundsPlayed: number;
  totalBids: number;
  winnerId: string;
  playerStats: Record<string, PlayerStats>;
}

interface PlayerInfo {
  id: string;
  name: string;
  color: PlayerColor;
}

interface GameResultsScreenProps {
  stats: GameStats;
  players: PlayerInfo[];
  isHost: boolean;
  onReturnToLobby: () => void;
  onLeaveGame: () => void;
}

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      delayChildren: 0.2,
    },
  },
};

const cardVariants = {
  hidden: { opacity: 0, y: 20, scale: 0.95 },
  visible: {
    opacity: 1,
    y: 0,
    scale: 1,
    transition: { type: 'spring', stiffness: 300, damping: 24 },
  },
};

export function GameResultsScreen({
  stats,
  players,
  isHost,
  onReturnToLobby,
  onLeaveGame,
}: GameResultsScreenProps) {
  const winner = players.find(p => p.id === stats.winnerId);

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="fixed inset-0 z-40 flex flex-col items-center justify-center p-4 overflow-y-auto"
      style={{
        background: 'radial-gradient(ellipse at center, #1a0a2e 0%, #0d0416 70%, #050208 100%)',
      }}
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        className="text-center mb-6"
      >
        <div className="flex items-center justify-center gap-3 mb-2">
          <Trophy className="w-8 h-8 text-gold-accent" />
          <h1 className="text-3xl font-bold text-gold-accent">Game Over</h1>
          <Trophy className="w-8 h-8 text-gold-accent" />
        </div>
        {winner && (
          <p className="text-xl text-white-soft">
            <span className="font-bold">{winner.name}</span> wins!
          </p>
        )}
        <p className="text-white-soft/60 mt-1">
          {stats.roundsPlayed} rounds played - {stats.totalBids} bids made
        </p>
      </motion.div>

      {/* Player stat cards */}
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl w-full mb-8"
      >
        {players.map(player => (
          <motion.div key={player.id} variants={cardVariants}>
            <StatCard
              playerName={player.name}
              color={player.color}
              stats={stats.playerStats[player.id] || {
                bidsPlaced: 0,
                dudosCalled: 0,
                dudosSuccessful: 0,
                calzasCalled: 0,
                calzasSuccessful: 0,
                diceLost: 0,
                diceGained: 0,
              }}
              isWinner={player.id === stats.winnerId}
            />
          </motion.div>
        ))}
      </motion.div>

      {/* Action buttons */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.5 }}
        className="flex gap-4"
      >
        {isHost ? (
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={onReturnToLobby}
            className="flex items-center gap-2 px-6 py-3 bg-gold-accent text-purple-deep font-bold rounded-lg uppercase tracking-wider"
          >
            <RotateCcw className="w-5 h-5" />
            Return to Lobby
          </motion.button>
        ) : (
          <p className="text-white-soft/60 py-3">Waiting for host to return to lobby...</p>
        )}

        <motion.button
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          onClick={onLeaveGame}
          className="flex items-center gap-2 px-6 py-3 bg-purple-mid/50 border border-purple-light/30 text-white-soft font-bold rounded-lg uppercase tracking-wider"
        >
          <Home className="w-5 h-5" />
          Leave Game
        </motion.button>
      </motion.div>
    </motion.div>
  );
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - all new components compile without errors</verify>
  <done>DiceExplosion animates 12 dice exploding outward with physics. StatCard shows player stats with color and winner indication. GameResultsScreen displays all player stats in grid with Return to Lobby (host only) and Leave Game buttons.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance VictoryScreen and integrate celebration flow</name>
  <files>src/components/VictoryScreen.tsx</files>
  <action>
Update src/components/VictoryScreen.tsx to add dice explosion and sound:

1. Import DiceExplosion and useSoundEffects:
```typescript
import { DiceExplosion } from './DiceExplosion';
import { useSoundEffects } from '@/hooks/useSoundEffects';
```

2. Add state for explosion complete:
```typescript
const [explosionComplete, setExplosionComplete] = useState(false);
```

3. Add sound effect on mount:
```typescript
const { playVictory, playDiceRattle } = useSoundEffects();

useEffect(() => {
  // Play victory sound and dice rattle on mount
  playVictory();
  setTimeout(() => playDiceRattle(), 500);
}, [playVictory, playDiceRattle]);
```

4. Add DiceExplosion component at the beginning of the render, before the existing content but after the background:
```typescript
{/* Dice explosion overlay */}
{!explosionComplete && (
  <DiceExplosion
    color={playerColor}
    onComplete={() => setExplosionComplete(true)}
  />
)}
```

5. Update the "Play Again" button to use the new onPlayAgain callback instead of potentially navigating. Keep the existing button but ensure it calls the prop correctly.

6. Add skip functionality: Allow clicking anywhere after 3 seconds to skip celebration. Add after the main content div:
```typescript
const [canSkip, setCanSkip] = useState(false);

useEffect(() => {
  const timer = setTimeout(() => setCanSkip(true), 3000);
  return () => clearTimeout(timer);
}, []);

// Add onClick handler to the main container
<motion.div
  onClick={() => canSkip && onPlayAgain()}
  className="fixed inset-0 z-50 ..."
  style={{ cursor: canSkip ? 'pointer' : 'default' }}
>
```

7. Add skip hint text at bottom when canSkip is true:
```typescript
{canSkip && (
  <motion.p
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    className="absolute bottom-8 left-1/2 -translate-x-1/2 text-white-soft/40 text-sm"
  >
    Click anywhere to continue
  </motion.p>
)}
```

The updated VictoryScreen now has:
- Dice explosion animation from center
- Victory sound on mount
- Dice rattle sound shortly after
- Skip capability after 3 seconds
- All existing celebration elements (confetti, fireworks, crown, trophy)
  </action>
  <verify>Run `npx tsc --noEmit` - VictoryScreen compiles with new features</verify>
  <done>VictoryScreen plays victory sound, shows dice explosion animation, allows skip after 3 seconds. Full celebration sequence with existing confetti and fireworks plus new dice explosion.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes without errors
2. `npm list use-sound` shows package installed
3. useSoundEffects.ts exists in src/hooks/
4. DiceExplosion.tsx, StatCard.tsx, GameResultsScreen.tsx exist in src/components/
5. VictoryScreen.tsx imports and uses DiceExplosion and useSoundEffects
6. public/sounds/ directory exists with README.md
</verification>

<success_criteria>
- [ ] use-sound package installed
- [ ] useSoundEffects hook created with playVictory, playPop, playDiceRattle
- [ ] public/sounds/ directory created with README explaining sound file sources
- [ ] DiceExplosion component animates 12 dice exploding from center
- [ ] StatCard component displays player name, color, and all stats
- [ ] GameResultsScreen displays stats grid with Return to Lobby (host) and Leave Game buttons
- [ ] VictoryScreen enhanced with DiceExplosion and sound effects
- [ ] VictoryScreen allows skip after 3 seconds
- [ ] All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-social-and-polish/09-03-SUMMARY.md`
</output>
