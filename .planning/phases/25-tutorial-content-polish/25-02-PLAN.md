---
phase: 25-tutorial-content-polish
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/components/tutorial/TutorialGameplay.tsx
  - src/components/tutorial/TutorialComplete.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can call Calza during tutorial when script requires it"
    - "Calza button pulses when highlighted"
    - "Confetti burst plays on tutorial completion"
    - "Tutorial auto-returns to main menu after 2 seconds"
    - "Wild ones (1s) count correctly during reveal"
  artifacts:
    - path: "src/components/tutorial/TutorialGameplay.tsx"
      provides: "Calza button in TutorialBidPanel, calza-button positioning, wild ones reveal support"
      contains: "onCalza|isCalzaAction|calza-button"
    - path: "src/components/tutorial/TutorialComplete.tsx"
      provides: "Confetti celebration with auto-return"
      contains: "confetti|setTimeout.*onExit.*2000"
    - path: "package.json"
      provides: "canvas-confetti dependency"
      contains: "canvas-confetti"
  key_links:
    - from: "src/components/tutorial/TutorialComplete.tsx"
      to: "canvas-confetti"
      via: "import and useEffect"
      pattern: "import confetti"
    - from: "src/components/tutorial/TutorialGameplay.tsx"
      to: "src/lib/tutorial/script.ts"
      via: "requiredAction.type === 'calza'"
      pattern: "type.*calza"
---

<objective>
Add Calza button to tutorial UI and completion celebration with confetti

Purpose: Complete the tutorial UX so users can perform Calza action and receive satisfying completion celebration per CONTEXT.md
Output: Working Calza button in TutorialBidPanel, confetti burst on completion, auto-return to main menu after 2 seconds
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-tutorial-content-polish/25-CONTEXT.md
@.planning/phases/25-tutorial-content-polish/25-RESEARCH.md
@.planning/phases/25-tutorial-content-polish/25-01-SUMMARY.md

@src/components/tutorial/TutorialGameplay.tsx
@src/components/tutorial/TutorialComplete.tsx
@src/components/BidUI.tsx (reference for Calza button styling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti for celebration effect</name>
  <files>package.json</files>
  <action>
    Install canvas-confetti and its TypeScript types:

    ```bash
    npm install canvas-confetti
    npm install --save-dev @types/canvas-confetti
    ```

    This is the lightweight (6KB) confetti library recommended in RESEARCH.md for the completion celebration.
  </action>
  <verify>`npm list canvas-confetti` shows the package installed</verify>
  <done>package.json has canvas-confetti in dependencies and @types/canvas-confetti in devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Add Calza button to TutorialBidPanel and update positioning</name>
  <files>src/components/tutorial/TutorialGameplay.tsx</files>
  <action>
    Modify the TutorialBidPanel component inside TutorialGameplay.tsx:

    1. Add Target icon import from lucide-react (already imported at top: Send, AlertTriangle)
       Add: `import { Send, AlertTriangle, Target } from 'lucide-react';`

    2. Add onCalza prop to TutorialBidPanelProps interface:
       ```typescript
       interface TutorialBidPanelProps {
         // ... existing props
         onCalza: () => void;
       }
       ```

    3. Add Calza action detection in TutorialBidPanel:
       ```typescript
       const isCalzaAction = scriptStep.requiredAction.type === 'calza';
       const shouldPulseCalza = scriptStep.highlightButton === 'calza';
       ```

    4. Add Calza disabled tooltip helper:
       ```typescript
       const getCalzaDisabledTooltip = () => {
         if (isDudoAction || isBidAction) {
           return "Calza is for exact matches only";
         }
         return "Watch what happens first";
       };
       ```

    5. Add Calza button after DUDO button (inside the currentBid && block):
       ```typescript
       {/* CALZA button - only shown when there's a current bid */}
       {currentBid && (
         isCalzaAction ? (
           <motion.button
             whileHover={{ scale: 1.02 }}
             whileTap={{ scale: 0.98 }}
             onClick={onCalza}
             className="w-full py-2 sm:py-2.5 px-3 rounded-lg font-bold uppercase text-xs sm:text-[11px] flex items-center justify-center gap-1"
             style={{
               background: 'linear-gradient(180deg, #22c55e 0%, #16a34a 100%)',
               border: '2px solid #4ade80',
               borderBottom: '3px solid #15803d',
               color: '#fff',
               letterSpacing: '0.15em',
               boxShadow: '0 3px 0 0 #166534, 0 5px 10px 0 rgba(0, 0, 0, 0.5)',
             }}
             animate={shouldPulseCalza && !useSimplifiedAnimations ? pulseAnimation : undefined}
             transition={shouldPulseCalza && !useSimplifiedAnimations ? pulseTransition : undefined}
           >
             <Target className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
             CALZA!
           </motion.button>
         ) : (
           <DisabledButtonWrapper tooltipText={getCalzaDisabledTooltip()} playerColor={playerColor}>
             <button
               aria-disabled="true"
               className="w-full py-2 sm:py-2.5 px-3 rounded-lg font-bold uppercase text-xs sm:text-[11px] flex items-center justify-center gap-1 opacity-50 cursor-not-allowed"
               style={{
                 background: 'linear-gradient(180deg, #22c55e 0%, #16a34a 100%)',
                 border: '2px solid #4ade80',
                 borderBottom: '3px solid #15803d',
                 color: '#fff',
                 letterSpacing: '0.15em',
               }}
               onClick={(e) => e.preventDefault()}
             >
               <Target className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
               CALZA!
             </button>
           </DisabledButtonWrapper>
         )
       )}
       ```

    6. Update getTooltipPosition to handle 'calza-button':
       ```typescript
       case 'calza-button':
         // Same position as dudo-button (above bid panel)
         return {
           top: '38%',
           left: '50%',
           transform: 'translateX(-50%)',
         };
       ```

    7. Add handleCalza callback in TutorialGameplay:
       ```typescript
       const handleCalza = useCallback(() => {
         if (!scriptStep) return;
         if (scriptStep.requiredAction.type !== 'calza') return;
         if (!currentBid) return;

         handleReveal('player', currentBid, playerHand, opponents);
       }, [scriptStep, currentBid, playerHand, opponents, handleReveal]);
       ```

    8. Pass onCalza to TutorialBidPanel:
       ```typescript
       <TutorialBidPanel
         // ... existing props
         onCalza={handleCalza}
       />
       ```

    9. Update countMatching call in handleReveal to NOT use palifico mode (so wild 1s count):
       Change: `const matching = countMatching(allDice, bidToReveal.value, true);`
       To: `const matching = countMatching(allDice, bidToReveal.value, false);`

       This ensures 1s count as wild during reveal for ones teaching steps.

       Also update isDieMatching to check for wild ones:
       ```typescript
       const isDieMatching = useCallback(
         (value: number) => {
           if (!currentBid) return false;
           return value === currentBid.value || value === 1; // 1s are wild
         },
         [currentBid]
       );
       ```

       And update getAllMatchingDice similarly to include wild 1s.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>TutorialBidPanel has Calza button with green styling, pulse animation, disabled state with tooltip, and wild ones count correctly in reveals</done>
</task>

<task type="auto">
  <name>Task 3: Add confetti celebration and auto-return to TutorialComplete</name>
  <files>src/components/tutorial/TutorialComplete.tsx</files>
  <action>
    Rewrite TutorialComplete.tsx to add confetti burst and auto-return per CONTEXT.md:

    1. Add confetti import:
       ```typescript
       import confetti from 'canvas-confetti';
       ```

    2. Add useEffect import (already imported from React)

    3. Add confetti burst on mount:
       ```typescript
       // Fire confetti on mount
       useEffect(() => {
         // Check for reduced motion preference
         const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
         if (prefersReducedMotion) return;

         // Main burst from center
         confetti({
           particleCount: 100,
           spread: 70,
           origin: { y: 0.6 },
           colors: [colorConfig.bg, colorConfig.glow, '#ffd700', '#ffffff'],
           disableForReducedMotion: true,
         });

         // Side cannons after 200ms
         const sideTimer = setTimeout(() => {
           confetti({
             particleCount: 50,
             angle: 60,
             spread: 55,
             origin: { x: 0 },
             colors: [colorConfig.bg, colorConfig.glow, '#ffd700'],
           });
           confetti({
             particleCount: 50,
             angle: 120,
             spread: 55,
             origin: { x: 1 },
             colors: [colorConfig.bg, colorConfig.glow, '#ffd700'],
           });
         }, 200);

         return () => clearTimeout(sideTimer);
       }, [colorConfig]);
       ```

    4. Add auto-return after 2 seconds:
       ```typescript
       // Auto-return to main menu after 2 seconds (per CONTEXT.md)
       useEffect(() => {
         const timer = setTimeout(() => {
           onExit();
         }, 2000);
         return () => clearTimeout(timer);
       }, [onExit]);
       ```

    5. Simplify the UI - remove the manual button per CONTEXT.md ("No manual button needed"):
       - Remove the action button with ArrowRight icon
       - Keep just the success icon and "You're ready to play!" text
       - Update the title to match CONTEXT.md: "You're ready to play!"

    6. Remove ArrowRight import (no longer needed)

    Final component should show:
    - Success icon with player color gradient
    - "You're ready to play!" title
    - Confetti burst on mount
    - Auto-return after 2 seconds
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`, build succeeds: `npm run build`</verify>
  <done>TutorialComplete has confetti burst on mount, auto-return after 2 seconds, no manual button</done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Build: `npm run build` succeeds
3. Dependencies: `npm list canvas-confetti` shows installed
4. Manual test: Start tutorial, complete all steps, verify:
   - Calza button appears and works when script requires it
   - Wild ones (1s) count correctly during reveal phases
   - Confetti fires on completion screen
   - Auto-returns to main menu after ~2 seconds
</verification>

<success_criteria>
- canvas-confetti installed and working
- Calza button in TutorialBidPanel with green styling matching BidUI.tsx
- Calza button pulses when highlightButton === 'calza'
- Calza button disabled with tooltip when action is not 'calza'
- Confetti burst on TutorialComplete mount (with reduced motion check)
- Auto-return to main menu after 2 seconds
- No manual "Start Playing" button on completion screen
- Wild 1s count correctly during reveal (palifico=false in countMatching)
</success_criteria>

<output>
After completion, create `.planning/phases/25-tutorial-content-polish/25-02-SUMMARY.md`
</output>
