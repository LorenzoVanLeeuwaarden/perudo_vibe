---
phase: 07-turn-timers
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/TurnTimer.tsx
  - src/components/GameBoard.tsx
  - src/components/BidUI.tsx
autonomous: true

must_haves:
  truths:
    - "All players see synchronized countdown timer during active turn"
    - "Timer changes color as time depletes (green > yellow > red)"
    - "Timer pulses in final seconds for urgency"
    - "Robot badge appears on bids made by timeout AI"
    - "Timer only shows during bidding phase"
  artifacts:
    - path: "src/components/TurnTimer.tsx"
      provides: "Progress bar timer with color transitions and pulse"
      min_lines: 50
    - path: "src/components/GameBoard.tsx"
      provides: "TurnTimer integration during bidding phase"
      contains: "TurnTimer"
    - path: "src/components/BidUI.tsx"
      provides: "Robot badge indicator for AI timeout moves"
      contains: "Bot"
  key_links:
    - from: "src/components/TurnTimer.tsx"
      to: "roomState.gameState.turnStartedAt"
      via: "props from GameBoard"
      pattern: "turnStartedAt"
    - from: "src/components/GameBoard.tsx"
      to: "src/components/TurnTimer.tsx"
      via: "import and render"
      pattern: "<TurnTimer"
---

<objective>
Create TurnTimer UI component with progress bar countdown and integrate it into the game board.

Purpose: Show all players a synchronized countdown timer so they know how much time the current player has. Visual urgency (color changes, pulsing) gives warning before timeout. Robot badge indicates when AI took over due to timeout.

Output: TurnTimer component rendered in GameBoard during bidding, shows progress bar with seconds, color transitions, pulse effect, and robot badge on timeout moves.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-turn-timers/07-CONTEXT.md
@.planning/phases/07-turn-timers/07-RESEARCH.md
@.planning/phases/07-turn-timers/07-01-SUMMARY.md

Key decisions from CONTEXT.md:
- Progress bar style, positioned center of board
- Always show numeric seconds alongside the bar
- Color change: green (>50%) -> yellow (25-50%) -> red (<25%)
- Pulsing animation in final 5-10 seconds (when <25% remaining)
- Robot badge next to current bid when lastActionWasTimeout is true
- Badge persists until next player makes a move

From RESEARCH.md - client countdown pattern:
- Calculate remaining: turnStartedAt + turnTimeoutMs - Date.now()
- Update every 100ms via setInterval
- Use Framer Motion for progress bar animation and pulse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TurnTimer component with progress bar</name>
  <files>src/components/TurnTimer.tsx</files>
  <action>
Create a new TurnTimer component with the following:

Props interface:
```typescript
interface TurnTimerProps {
  turnStartedAt: number;      // Unix timestamp when turn started
  turnTimeoutMs: number;      // Total turn time in milliseconds
  isMyTurn: boolean;          // Highlight differently if it's the viewer's turn
}
```

Implementation:
1. Use useState for remainingMs, update every 100ms via useEffect with setInterval
2. Calculate progress as `remainingMs / turnTimeoutMs` (1 = full, 0 = empty)
3. Calculate seconds as `Math.ceil(remainingMs / 1000)`

Color function:
```typescript
function getTimerColor(progress: number): string {
  if (progress > 0.5) return 'bg-green-crt';     // > 50% remaining
  if (progress > 0.25) return 'bg-yellow-400';   // 25-50% remaining
  return 'bg-red-crt';                           // < 25% remaining
}
```

Pulse logic:
- isPulsing = progress <= 0.25 (final 25% of time)

Render structure:
```tsx
<div className="w-full max-w-xs mx-auto">
  {/* Background track */}
  <div className="h-3 bg-purple-deep rounded-full overflow-hidden border border-purple-mid">
    {/* Progress fill with Framer Motion */}
    <motion.div
      className={`h-full ${color} transition-colors duration-300`}
      style={{ width: `${progress * 100}%` }}
      animate={isPulsing ? { opacity: [1, 0.5, 1] } : { opacity: 1 }}
      transition={isPulsing ? { duration: 0.5, repeat: Infinity } : {}}
    />
  </div>
  {/* Numeric display */}
  <p className={`text-center mt-1 font-mono text-lg ${isPulsing ? 'text-red-crt' : 'text-white-soft'}`}>
    {seconds}s
  </p>
</div>
```

Handle edge cases:
- If turnTimeoutMs is 0 or undefined, don't render (timer disabled)
- Clamp remainingMs to 0 minimum
  </action>
  <verify>
File exists: `ls src/components/TurnTimer.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
TurnTimer component created with progress bar, color transitions (green/yellow/red), pulse animation, and numeric seconds display
  </done>
</task>

<task type="auto">
  <name>Task 2: Add robot badge to BidUI for timeout moves</name>
  <files>src/components/BidUI.tsx</files>
  <action>
First read the existing BidUI.tsx to understand its structure.

Add a prop to indicate if the last bid was auto-played:
```typescript
interface BidUIProps {
  // ... existing props
  wasAutoPlayed?: boolean;  // True if current bid was made by timeout AI
}
```

Where the current bid is displayed (e.g., "3x fives by PlayerName"), add a small robot icon badge next to it when wasAutoPlayed is true:

1. Import Bot icon from lucide-react: `import { Bot } from 'lucide-react';`

2. Near the bid display, add conditional robot badge:
```tsx
{wasAutoPlayed && (
  <span className="inline-flex items-center ml-2 px-1.5 py-0.5 bg-purple-mid/50 rounded text-xs text-white-soft/70">
    <Bot className="w-3 h-3 mr-0.5" />
    Auto
  </span>
)}
```

The badge should be:
- Small and unobtrusive (text-xs)
- Positioned next to the current bid text
- Use the Bot icon from lucide-react
- Show "Auto" text for clarity
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Check import: `grep "Bot" src/components/BidUI.tsx`
Check prop: `grep "wasAutoPlayed" src/components/BidUI.tsx`
  </verify>
  <done>
BidUI shows robot badge with "Auto" text when wasAutoPlayed prop is true, badge is small and unobtrusive
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate TurnTimer into GameBoard</name>
  <files>src/components/GameBoard.tsx</files>
  <action>
Integrate the TurnTimer component and pass wasAutoPlayed to BidUI:

1. Import TurnTimer: `import { TurnTimer } from './TurnTimer';`

2. Extract timer values from gameState:
```typescript
const turnStartedAt = gameState.turnStartedAt;
const turnTimeoutMs = roomState.settings.turnTimeoutMs;
const wasAutoPlayed = gameState.lastActionWasTimeout ?? false;
```

3. Add TurnTimer to the bidding phase UI, positioned above the BidUI component:
```tsx
{gameState.phase === 'bidding' && !isRevealPhase && !isEndedPhase && (
  <>
    {/* Turn timer - only show if timeout is configured */}
    {turnTimeoutMs > 0 && turnStartedAt && (
      <div className="mb-4">
        <TurnTimer
          turnStartedAt={turnStartedAt}
          turnTimeoutMs={turnTimeoutMs}
          isMyTurn={isMyTurn}
        />
      </div>
    )}
    <BidUI
      // ... existing props
      wasAutoPlayed={wasAutoPlayed}
    />
  </>
)}
```

4. Pass wasAutoPlayed prop to BidUI component

Note: The timer should NOT show during rolling or reveal phases - it only shows during active bidding.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Check TurnTimer import: `grep "TurnTimer" src/components/GameBoard.tsx`
Check timer rendered: `grep -A3 "turnTimeoutMs > 0" src/components/GameBoard.tsx`
  </verify>
  <done>
TurnTimer renders in GameBoard during bidding phase, positioned above BidUI, wasAutoPlayed passed to BidUI for robot badge
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Visual verification (during execute-phase human testing):
   - Start game with 30s turn time
   - Observe timer countdown
   - Observe color changes at ~15s (yellow) and ~7s (red)
   - Observe pulse animation in final seconds
   - Let timer expire, observe robot badge on auto-played bid
</verification>

<success_criteria>
- TurnTimer component exists with progress bar and numeric seconds
- Color transitions work: green (>50%) -> yellow (25-50%) -> red (<25%)
- Pulse animation activates in final 25% of time
- Timer renders in GameBoard only during bidding phase
- Robot badge shows on BidUI when lastActionWasTimeout is true
- Timer hidden when turnTimeoutMs is 0 (disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/07-turn-timers/07-02-SUMMARY.md`
</output>
