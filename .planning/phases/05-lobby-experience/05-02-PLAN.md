---
phase: 05-lobby-experience
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/PlayerRow.tsx
  - src/components/PlayerList.tsx
  - src/components/KickConfirmDialog.tsx
  - src/components/GameSettingsModal.tsx
  - src/components/RoomLobby.tsx
  - src/app/room/[code]/page.tsx
autonomous: false

must_haves:
  truths:
    - "All players see the player list with names and colors in real-time"
    - "Host is indicated with a crown icon visible to all players"
    - "Host sees kick button (X) on non-host player rows"
    - "Kicking a player shows confirmation modal before removal"
    - "Host sees Configure Game button that opens settings modal"
    - "Non-host players see settings but cannot edit them"
    - "Host sees Start Game button that is enabled when 2-6 players present"
    - "Non-host players see 'Waiting for host...' instead of Start button"
  artifacts:
    - path: "src/components/PlayerRow.tsx"
      provides: "Individual player display with crown, color, kick button"
      min_lines: 40
    - path: "src/components/PlayerList.tsx"
      provides: "Animated list with AnimatePresence"
      contains: "AnimatePresence"
    - path: "src/components/KickConfirmDialog.tsx"
      provides: "Confirmation modal for kicking players"
      contains: "Remove.*\\?"
    - path: "src/components/GameSettingsModal.tsx"
      provides: "Settings modal with dice count, wild ones, turn time"
      contains: "startingDice|palificoEnabled|turnTimeoutMs"
    - path: "src/components/RoomLobby.tsx"
      provides: "Integrated lobby with player list, settings, start button"
      min_lines: 100
  key_links:
    - from: "src/components/RoomLobby.tsx"
      to: "PlayerList"
      via: "component import and render"
      pattern: "import.*PlayerList|<PlayerList"
    - from: "src/components/RoomLobby.tsx"
      to: "sendMessage"
      via: "prop drilling from room page"
      pattern: "sendMessage.*KICK_PLAYER|sendMessage.*START_GAME"
    - from: "src/app/room/[code]/page.tsx"
      to: "SETTINGS_UPDATED handler"
      via: "handleMessage switch case"
      pattern: "case.*SETTINGS_UPDATED"
---

<objective>
Build lobby UI components: player list with animations, host controls, settings modal, and start game flow

Purpose: Create the full lobby experience where players see each other in real-time, host can manage the room, and everyone can see when the game is about to start.

Output: Complete lobby UI with PlayerList, PlayerRow, KickConfirmDialog, GameSettingsModal components integrated into RoomLobby with all host controls functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-lobby-experience/05-CONTEXT.md
@.planning/phases/05-lobby-experience/05-RESEARCH.md
@.planning/phases/05-lobby-experience/05-01-SUMMARY.md
@src/components/RoomLobby.tsx
@src/components/SettingsPanel.tsx
@src/app/room/[code]/page.tsx
@src/shared/types.ts
@src/shared/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerRow and PlayerList components</name>
  <files>src/components/PlayerRow.tsx, src/components/PlayerList.tsx</files>
  <action>
1. Create src/components/PlayerRow.tsx:
   - Props: player (ServerPlayer), isMe (boolean), showKick (boolean), onKick (() => void)
   - Layout: flex row with gap-3, p-3, rounded-lg border
   - Background: isMe ? 'bg-purple-mid/30 border-purple-glow' : 'bg-purple-deep/30 border-purple-mid'
   - Elements (left to right):
     - Color indicator: 4x4 rounded-full div with PLAYER_COLORS[player.color].bg
     - Name: flex-1 text-white-soft font-medium truncate
     - Crown icon: if player.isHost, show Crown from lucide-react (w-5 h-5 text-gold-accent)
     - Disconnected indicator: if !player.isConnected, show WifiOff (w-4 h-4 text-white-soft/40)
     - Kick button: if showKick, motion.button with X icon, hover:text-red-danger, whileHover/whileTap animations
   - Import PLAYER_COLORS from '@/lib/types'

2. Create src/components/PlayerList.tsx:
   - Props: players (ServerPlayer[]), myPlayerId (string), isHost (boolean), onKickPlayer ((playerId: string) => void)
   - Use framer-motion AnimatePresence with mode="popLayout"
   - Define playerVariants: initial { opacity: 0, x: -20, height: 0 }, animate { opacity: 1, x: 0, height: 'auto' }, exit { opacity: 0, x: 20, height: 0 }
   - Map over players, wrapping each in motion.div with key={player.id}, layout prop, variants, transition { type: 'spring', stiffness: 300, damping: 25 }
   - Render PlayerRow for each player with:
     - isMe={player.id === myPlayerId}
     - showKick={isHost && player.id !== myPlayerId}
     - onKick={() => onKickPlayer(player.id)}
  </action>
  <verify>
TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
  </verify>
  <done>
- PlayerRow displays player with color, name, crown badge, connection status, kick button
- PlayerList animates players entering/exiting with AnimatePresence
- Components exported and ready for integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KickConfirmDialog and GameSettingsModal components</name>
  <files>src/components/KickConfirmDialog.tsx, src/components/GameSettingsModal.tsx</files>
  <action>
1. Create src/components/KickConfirmDialog.tsx:
   - Props: isOpen (boolean), playerName (string), onConfirm (() => void), onCancel (() => void)
   - Follow SettingsPanel.tsx modal pattern exactly:
     - AnimatePresence wrapping conditional render
     - Outer motion.div: fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm, onClick={onCancel}
     - Inner motion.div: retro-panel p-6 max-w-sm w-full mx-4, onClick stopPropagation
     - Animations: initial { opacity: 0, scale: 0.9 }, animate { opacity: 1, scale: 1 }, exit same as initial
   - Content:
     - h2: "Remove {playerName}?" (text-xl font-bold text-white-soft mb-2)
     - p: "They will be removed from the lobby and redirected to the home page." (text-white-soft/60 mb-6)
     - Button row: flex gap-3
       - Cancel button: flex-1 py-2 rounded-lg bg-purple-mid border border-purple-glow text-white-soft
       - Kick button: flex-1 py-2 rounded-lg bg-red-danger text-white font-bold

2. Create src/components/GameSettingsModal.tsx:
   - Props: isOpen (boolean), onClose (() => void), settings (GameSettings), onSave ((settings: Partial<GameSettings>) => void), isHost (boolean)
   - Same modal pattern as KickConfirmDialog
   - Define TURN_TIME_OPTIONS array: [{ value: 30000, label: '30s' }, { value: 60000, label: '60s' }, { value: 90000, label: '90s' }, { value: 0, label: 'Unlimited' }]
   - Local state: [localSettings, setLocalSettings] = useState(settings) - sync with useEffect when settings prop changes
   - Content sections:
     a. Starting Dice (1-5):
        - Label: "Starting Dice" with current value display
        - Decrement/increment buttons (disabled if !isHost or at min/max)
        - Value display between buttons
     b. Wild Ones (palifico):
        - Toggle switch like SettingsPanel.tsx
        - Label: "Wild Ones (Palifico)"
        - Description: "Ones count as wilds (except in palifico rounds)"
     c. Turn Time:
        - Button group for TURN_TIME_OPTIONS
        - Selected option highlighted with bg-purple-glow
   - Footer:
     - If isHost: Save button (disabled if no changes)
     - If not host: "Only the host can change settings" message
   - On save: call onSave with changed fields only, then onClose
  </action>
  <verify>
TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
  </verify>
  <done>
- KickConfirmDialog shows confirmation with Cancel/Kick buttons
- GameSettingsModal shows all three settings with host-only editing
- Both follow established modal pattern from SettingsPanel
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into RoomLobby and room page</name>
  <files>src/components/RoomLobby.tsx, src/app/room/[code]/page.tsx</files>
  <action>
1. Update src/app/room/[code]/page.tsx handleMessage to handle new messages:
   - Add case 'SETTINGS_UPDATED': Update roomState.settings in joinState
   - Add case 'HOST_CHANGED': Update roomState.hostId and players' isHost flags
   - Add case 'GAME_STARTED': (stub for Phase 6) console.log for now, transition will be handled in game phase
   - Pass sendMessage function to RoomLobby: create wrapper function that sends via wsRef

2. Update RoomLobby props:
   - Add: sendMessage: (msg: ClientMessage) => void
   - Add: onKickPlayer: (playerId: string) => void (can be inline in parent)

3. Rewrite RoomLobby to include full lobby UI:
   - State: showKickDialog (string | null for player id), showSettings (boolean)
   - Derive: isHost = roomState.hostId === myPlayerId, connectedCount = players.filter(p => p.isConnected).length, canStart = connectedCount >= 2 && connectedCount <= 6

   - Layout (top to bottom within retro-panel):
     a. Start Game section (at top per CONTEXT.md):
        - If isHost: motion.button with "Start Game" (disabled if !canStart, gold-accent when enabled)
        - If not host: "Waiting for host... ({connectedCount}/6 players)" centered text

     b. Player List section:
        - PlayerList component with players, myPlayerId, isHost, onKickPlayer handler
        - onKickPlayer opens KickConfirmDialog by setting showKickDialog to player.id

     c. Settings section:
        - "Configure Game" button (only for host) or "Game Settings" for non-host
        - Opens GameSettingsModal

     d. Share section (existing RoomShare component):
        - Keep existing RoomShare for link sharing

   - KickConfirmDialog:
     - isOpen={!!showKickDialog}
     - playerName={players.find(p => p.id === showKickDialog)?.name ?? ''}
     - onCancel={() => setShowKickDialog(null)}
     - onConfirm: sendMessage({ type: 'KICK_PLAYER', playerId: showKickDialog, timestamp: Date.now() }), then setShowKickDialog(null)

   - GameSettingsModal:
     - isOpen={showSettings}
     - onClose={() => setShowSettings(false)}
     - settings={roomState.settings}
     - isHost={isHost}
     - onSave: sendMessage({ type: 'UPDATE_SETTINGS', settings: partialSettings, timestamp: Date.now() })

   - Start Game onClick: sendMessage({ type: 'START_GAME', timestamp: Date.now() })

4. Handle kicked player redirect in room page:
   - In PLAYER_LEFT handler, check if message.playerId === joinState.playerId && message.reason === 'kicked'
   - If so: toast.error('You were removed from the room'), router.push('/')
  </action>
  <verify>
TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
Dev server starts: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npm run dev` (check it starts without errors, then stop)
  </verify>
  <done>
- RoomLobby shows player list with animations, host controls, settings modal, start button
- Room page handles SETTINGS_UPDATED, HOST_CHANGED, GAME_STARTED messages
- Kicked player is redirected to home with toast notification
- All host actions send appropriate messages to server
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete lobby experience with:
- Animated player list showing all players with colors and crown for host
- Host can kick players (with confirmation dialog)
- Host can configure game settings (starting dice, wild ones, turn time)
- Host sees enabled Start Game button when 2-6 players present
- Non-host sees waiting message
- Host transfer when host disconnects
  </what-built>
  <how-to-verify>
1. Open two browser windows (or one regular + one incognito)
2. In Window 1: Create a multiplayer room, join with nickname "Player1"
3. In Window 2: Join same room with nickname "Player2"
4. Verify both windows show player list with both players
5. Verify Player1 has crown icon (host)
6. In Window 1 (host): Verify "Start Game" button is enabled (2 players)
7. In Window 2 (non-host): Verify "Waiting for host..." message shown
8. In Window 1: Click Configure Game, change settings, click Save
9. Verify Window 2 shows updated settings (open settings modal)
10. In Window 1: Click X on Player2's row, confirm kick
11. Verify Window 2 is redirected to home with "removed" toast
12. In Window 2: Rejoin the room
13. In Window 1: Close the browser tab (simulate host disconnect)
14. Verify Window 2 now shows crown (became host)
15. Verify Window 2 now sees "Start Game" button (needs 1 more player)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. All lobby UI components render correctly
3. Player list animates on join/leave
4. Host controls (kick, settings, start) only visible to host
5. Non-host sees read-only settings and waiting message
6. Host transfer works when host disconnects
7. Kicked player redirected with toast
</verification>

<success_criteria>
- Player list visible to all with crown for host
- Host can kick players with confirmation
- Host can modify game settings
- Host can start game when 2-6 players present
- Non-host sees "Waiting for host..." message
- Host transfer automatic on disconnect
- Kicked player redirected to home with notification
</success_criteria>

<output>
After completion, create `.planning/phases/05-lobby-experience/05-02-SUMMARY.md`
</output>
