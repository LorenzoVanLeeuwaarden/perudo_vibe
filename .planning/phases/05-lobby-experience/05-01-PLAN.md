---
phase: 05-lobby-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - party/index.ts
  - src/shared/messages.ts
autonomous: true

must_haves:
  truths:
    - "Host can update game settings and all players receive the update"
    - "Host can kick a player and that player is removed from the room"
    - "Host can start the game when 2-6 players are present"
    - "When host disconnects, next player becomes host automatically"
    - "Non-host cannot update settings, kick players, or start the game"
  artifacts:
    - path: "party/index.ts"
      provides: "handleUpdateSettings, handleKickPlayer, handleStartGame implementations"
      contains: "handleUpdateSettings|handleKickPlayer|handleStartGame"
    - path: "src/shared/messages.ts"
      provides: "HOST_CHANGED server message type"
      contains: "HOST_CHANGED"
  key_links:
    - from: "party/index.ts handleKickPlayer"
      to: "PLAYER_LEFT broadcast"
      via: "broadcast with reason: kicked"
      pattern: "reason.*kicked"
    - from: "party/index.ts onClose"
      to: "HOST_CHANGED broadcast"
      via: "host transfer logic"
      pattern: "HOST_CHANGED"
---

<objective>
Implement server-side lobby control handlers in PartyKit server

Purpose: Enable host to manage room settings, kick players, and start the game. Handle host transfer when host disconnects.

Output: Fully functional server handlers for UPDATE_SETTINGS, KICK_PLAYER, START_GAME messages plus automatic host transfer on disconnect.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-lobby-experience/05-CONTEXT.md
@.planning/phases/05-lobby-experience/05-RESEARCH.md
@party/index.ts
@src/shared/messages.ts
@src/shared/types.ts
@src/shared/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HOST_CHANGED message and implement settings/kick handlers</name>
  <files>src/shared/messages.ts, party/index.ts</files>
  <action>
1. In src/shared/messages.ts, add HOST_CHANGED to ServerMessageSchema:
   ```typescript
   z.object({
     type: z.literal('HOST_CHANGED'),
     newHostId: z.string(),
     timestamp: TimestampSchema,
   }),
   ```

2. In party/index.ts, implement handleUpdateSettings:
   - Verify sender is host (this.roomState.hostId === sender.id)
   - If not host, sendError with type 'NOT_HOST', reason 'Only the host can change settings'
   - Verify game not in progress (gameState === null or phase === 'lobby')
   - Merge msg.settings into this.roomState.settings (partial update)
   - Persist state
   - Broadcast SETTINGS_UPDATED to all players with new settings

3. In party/index.ts, implement handleKickPlayer:
   - Verify sender is host
   - Verify target player exists and is not the host themselves
   - Find and remove player from this.roomState.players array
   - Persist state
   - Send PLAYER_LEFT to kicked player with reason: 'kicked'
   - Broadcast PLAYER_LEFT to others with reason: 'kicked'
   - Close kicked player's connection using this.room.getConnections()
  </action>
  <verify>
TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
  </verify>
  <done>
- HOST_CHANGED message type exists in ServerMessageSchema
- handleUpdateSettings validates host, merges settings, broadcasts SETTINGS_UPDATED
- handleKickPlayer validates host, removes player, broadcasts PLAYER_LEFT with kicked reason
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement start game handler and host transfer on disconnect</name>
  <files>party/index.ts</files>
  <action>
1. Implement handleStartGame:
   - Verify sender is host
   - Verify game not already in progress
   - Count connected players: this.roomState.players.filter(p => p.isConnected).length
   - If count < 2 or count > 6, sendError with type 'INVALID_ACTION', reason 'Need 2-6 players to start'
   - Set gameState to initial bidding phase:
     ```typescript
     this.roomState.gameState = {
       phase: 'rolling',
       players: this.roomState.players.filter(p => p.isConnected),
       currentBid: null,
       currentTurnPlayerId: this.roomState.players.find(p => p.isConnected)?.id ?? null,
       roundStarterId: this.roomState.players.find(p => p.isConnected)?.id ?? null,
       lastBidderId: null,
       isPalifico: false,
       roundNumber: 1,
       turnStartedAt: Date.now(),
     };
     ```
   - Give each player their starting dice (already have diceCount, hands will be dealt in Phase 6)
   - Persist state
   - Broadcast GAME_STARTED to all players

2. Enhance onClose for host transfer:
   - Check if disconnecting player was host (wasHost = this.roomState.hostId === connection.id)
   - After marking player disconnected, if wasHost:
     - Find first connected player: connectedPlayers = this.roomState.players.filter(p => p.isConnected && p.id !== connection.id)
     - If connectedPlayers.length > 0:
       - newHost = connectedPlayers[0] (earliest joined, array is ordered by join time)
       - this.roomState.hostId = newHost.id
       - Update isHost flags: old host's isHost = false, newHost.isHost = true
       - Broadcast HOST_CHANGED { newHostId: newHost.id, timestamp: Date.now() }
     - Persist state before broadcasting PLAYER_LEFT
  </action>
  <verify>
TypeScript compiles: `cd /Users/lorenzo.vanleeuwaarden/Documents/GitHub/perudo_vibe && npx tsc --noEmit`
  </verify>
  <done>
- handleStartGame validates host and player count, transitions to rolling phase, broadcasts GAME_STARTED
- onClose transfers host to earliest-joined connected player when host disconnects
- HOST_CHANGED broadcast sent when host transfers
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Server handles all three message types (UPDATE_SETTINGS, KICK_PLAYER, START_GAME)
3. Non-host requests are rejected with NOT_HOST error
4. Host transfer logic in onClose broadcasts HOST_CHANGED
</verification>

<success_criteria>
- All server message handlers implemented (no more TODO stubs)
- Host validation on all host-only actions
- Player count validation on START_GAME
- Automatic host transfer when host disconnects
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-lobby-experience/05-01-SUMMARY.md`
</output>
