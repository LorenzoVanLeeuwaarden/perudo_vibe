---
phase: 03-room-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/roomCode.ts
  - src/hooks/useRoomConnection.ts
  - .env.local

autonomous: true

must_haves:
  truths:
    - "Room code generation produces 6-char uppercase alphanumeric codes"
    - "Room codes exclude confusing characters (0/O, 1/I/L)"
    - "Room codes are case-insensitive (normalized to uppercase)"
    - "PartySocket hook connects to room and handles lifecycle"
  artifacts:
    - path: "src/lib/roomCode.ts"
      provides: "Room code generation and validation"
      exports: ["createRoomCode", "normalizeRoomCode", "isValidRoomCode"]
    - path: "src/hooks/useRoomConnection.ts"
      provides: "PartySocket connection hook"
      exports: ["useRoomConnection"]
    - path: ".env.local"
      provides: "PartyKit host configuration"
      contains: "NEXT_PUBLIC_PARTYKIT_HOST"
  key_links:
    - from: "src/lib/roomCode.ts"
      to: "src/shared/constants.ts"
      via: "imports ROOM_CODE_ALPHABET, ROOM_CODE_LENGTH"
      pattern: "import.*ROOM_CODE"
    - from: "src/hooks/useRoomConnection.ts"
      to: "partysocket/react"
      via: "usePartySocket hook"
      pattern: "usePartySocket"
---

<objective>
Create room code generation utilities and PartySocket connection infrastructure for multiplayer rooms.

Purpose: Establish the foundation for room creation - code generation and WebSocket connectivity that subsequent plans will build upon.
Output: Room code utility functions and a React hook for managing PartySocket connections to rooms.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-room-creation/03-RESEARCH.md

# Existing code
@src/shared/constants.ts - Has ROOM_CODE_ALPHABET and ROOM_CODE_LENGTH
@party/index.ts - Existing PartyKit server skeleton
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create room code utility</name>
  <files>src/lib/roomCode.ts</files>
  <action>
Create room code utility with three functions:

1. `createRoomCode()`: Generate 6-char room code using nanoid customAlphabet
   - Import ROOM_CODE_ALPHABET and ROOM_CODE_LENGTH from @/shared/constants
   - Use `customAlphabet` from nanoid (already installed)
   - Return uppercase string

2. `normalizeRoomCode(code: string)`: Normalize code for consistency
   - Convert to uppercase
   - Trim whitespace
   - Return normalized string

3. `isValidRoomCode(code: string)`: Validate a room code
   - Check length equals ROOM_CODE_LENGTH
   - Check all characters are in ROOM_CODE_ALPHABET
   - Return boolean

Example implementation:
```typescript
import { customAlphabet } from 'nanoid';
import { ROOM_CODE_LENGTH, ROOM_CODE_ALPHABET } from '@/shared/constants';

const generateCode = customAlphabet(ROOM_CODE_ALPHABET, ROOM_CODE_LENGTH);

export function createRoomCode(): string {
  return generateCode();
}

export function normalizeRoomCode(code: string): string {
  return code.toUpperCase().trim();
}

export function isValidRoomCode(code: string): boolean {
  const normalized = normalizeRoomCode(code);
  if (normalized.length !== ROOM_CODE_LENGTH) return false;
  return [...normalized].every(char => ROOM_CODE_ALPHABET.includes(char));
}
```
  </action>
  <verify>
Run TypeScript check:
```bash
npx tsc --noEmit src/lib/roomCode.ts
```
  </verify>
  <done>Room code utility exports createRoomCode, normalizeRoomCode, isValidRoomCode functions</done>
</task>

<task type="auto">
  <name>Task 2: Create useRoomConnection hook and environment config</name>
  <files>src/hooks/useRoomConnection.ts, .env.local</files>
  <action>
First, create .env.local with PartyKit host configuration:
```
NEXT_PUBLIC_PARTYKIT_HOST=localhost:1999
```

Then create the useRoomConnection hook:

1. Import usePartySocket from 'partysocket/react'
2. Import normalizeRoomCode from '@/lib/roomCode'
3. Accept roomCode as parameter
4. Return connection state and socket

The hook should:
- Normalize room code to uppercase before connecting
- Only connect when roomCode is truthy
- Provide connection callbacks (onOpen, onMessage, onClose, onError)
- Return the WebSocket instance and connection status

Example implementation:
```typescript
'use client';

import { useState, useCallback } from 'react';
import usePartySocket from 'partysocket/react';
import { normalizeRoomCode } from '@/lib/roomCode';
import type { ServerMessage } from '@/shared';

export type ConnectionStatus = 'connecting' | 'connected' | 'disconnected' | 'error';

interface UseRoomConnectionOptions {
  roomCode: string;
  onMessage?: (message: ServerMessage) => void;
  onStatusChange?: (status: ConnectionStatus) => void;
}

export function useRoomConnection({ roomCode, onMessage, onStatusChange }: UseRoomConnectionOptions) {
  const [status, setStatus] = useState<ConnectionStatus>('connecting');

  const handleStatusChange = useCallback((newStatus: ConnectionStatus) => {
    setStatus(newStatus);
    onStatusChange?.(newStatus);
  }, [onStatusChange]);

  const ws = usePartySocket({
    host: process.env.NEXT_PUBLIC_PARTYKIT_HOST!,
    room: normalizeRoomCode(roomCode),

    onOpen() {
      handleStatusChange('connected');
    },
    onMessage(event) {
      try {
        const message = JSON.parse(event.data) as ServerMessage;
        onMessage?.(message);
      } catch (err) {
        console.error('Failed to parse message:', err);
      }
    },
    onClose() {
      handleStatusChange('disconnected');
    },
    onError() {
      handleStatusChange('error');
    },
  });

  return { ws, status };
}
```

Note: The hook uses the existing partysocket package (already installed in Phase 1).
  </action>
  <verify>
1. Check .env.local exists:
```bash
cat .env.local | grep PARTYKIT
```

2. Run TypeScript check:
```bash
npx tsc --noEmit src/hooks/useRoomConnection.ts
```

3. Run build to ensure no import errors:
```bash
npm run build 2>&1 | head -50
```
  </verify>
  <done>.env.local has NEXT_PUBLIC_PARTYKIT_HOST set, useRoomConnection hook compiles and exports correctly</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Room code utility functions work:
   - createRoomCode() returns 6-char uppercase string
   - normalizeRoomCode() converts to uppercase
   - isValidRoomCode() validates correctly
3. Environment variable set for PartyKit host
4. useRoomConnection hook compiles and uses correct imports
</verification>

<success_criteria>
- Room code utility exports three functions (createRoomCode, normalizeRoomCode, isValidRoomCode)
- useRoomConnection hook connects to PartySocket with normalized room code
- Environment configured for local PartyKit development
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-room-creation/03-01-SUMMARY.md`
</output>
